<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
    o
    .sticky {
    position: sticky;
    z-index: 20;
    }

    .left-0 {
        left: 0;
    }

    /* Estilos para los select personalizados */
    select option {
        padding: 8px;
        margin: 2px;
    }

    select option[value="TRABAJO"] {
        background-color: rgb(220, 252, 231);
        color: rgb(22, 101, 52);
    }

    select option[value="VACACIONES"] {
        background-color: rgb(219, 234, 254);
        color: rgb(29, 78, 216);
    }

    select option[value="LIBRE"] {
        background-color: rgb(254, 226, 226);
        color: rgb(185, 28, 28);
    }

    select option[value="BAJA MÉDICA"] {
        background-color: rgb(243, 232, 255);
        color: rgb(107, 33, 168);
    }

    select option[value="FORMACIÓN"] {
        background-color: rgb(255, 237, 213);
        color: rgb(154, 52, 18);
    }

    select option[value="LACTANCIA"] {
        background-color: rgb(252, 231, 243);
        color: rgb(157, 23, 77);
    }

    /* Transición suave para los cambios de color */
    .time-select {
        transition: all 0.3s ease-in-out;
    }

    /* Efecto de actualización */
    @keyframes updateFlash {
        0% {
            background-color: inherit;
        }
        50% {
            background-color: rgba(59, 130, 246, 0.1); /* Azul muy suave */
        }
        100% {
            background-color: inherit;
        }
    }

    .update-flash {
        animation: updateFlash 0.5s ease;
    }

    /* Transiciones suaves para los diferentes estados */
    select option[value="TRABAJO"] {
        transition: background-color 0.3s ease;
    }

    select option[value="VACACIONES"] {
        transition: background-color 0.3s ease;
    }

    /* Efecto de actualización para las celdas de horas */
    @keyframes numberUpdate {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
            color: #3B82F6; /* Azul */
        }
        100% {
            transform: scale(1);
        }
    }

    .number-update {
        animation: numberUpdate 0.3s ease;
    }
    
    .traffic-cell {
        transition: all 0.2s ease-in-out;
    }
    .traffic-cell:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,
    }
    
    </style>
</head>
<body>
    <div id="lcdc-schedule-manager" class="lcdc-schedule min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="lcdc-header bg-white shadow-sm">
            <div class="lcdc-header-container max-w-7xl mx-auto px-4 py-4">
                <div class="lcdc-header-content flex items-center justify-between">
                    <div class="lcdc-header-left flex items-center gap-4">
                        <button id="lcdc-back-button" class="lcdc-back p-2 hover:bg-gray-100 rounded-full hidden">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex items-center gap-2">
                            <button id="prev-year" class="p-2 hover:bg-gray-100 rounded-full">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <h1 id="lcdc-view-title" class="lcdc-title text-xl font-semibold text-gray-900">Cargando...</h1>
                            <button id="next-year" class="p-2 hover:bg-gray-100 rounded-full">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Main Content -->
        <div class="lcdc-main max-w-7xl mx-auto px-4 py-8">
            <!-- Year View -->
            <div id="lcdc-year-view" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="col-span-full text-center text-gray-500">Cargando datos...</div>
            </div>
        </div>

    <script>
        // Mantener las configuraciones existentes de Airtable
        const baseId = "appxCzcdyajOiece8";
        const apiKey = "patFKh76g2DNkVk36.8f69188009d491d86e0ba54081887c274e21eb540a5f0cc5c4c8a7ed72332dde";
        const semanasLaboralesTableId = "tblY4azExiLi7dbcw";
        const tiendaSupervisorTableId = "tblpHRqsBrADEkeUL";
        const actividadDiariaTableId = "tblbkzixVwxZ8oVqb";
        const diasLaboralesTableId = "tblZHaVWLq5KKEmgW";
        const actividadEstados = new Map();
        const estadosActividad = new Map();

        const opcionesDropdown = [
            'TRABAJO',
            'VACACIONES',
            'LIBRE',
            'BAJA MÉDICA',
            'FORMACIÓN',
            'LACTANCIA'
        ];

        // Verificar Constantes
        console.log('Configuración:', {
            baseId,
            semanasLaboralesTableId,
            tiendaSupervisorTableId
        });
        
        let currentYear = null;
        let availableYears = [];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            inicializarModalDia();
            agregarEstilosActualizacion();
        });

        function mostrarCargando() {
            document.getElementById('lcdc-year-view').innerHTML = `
                <div class="col-span-full flex items-center justify-center gap-2 text-gray-500">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                    <span>Cargando datos...</span>
                </div>
            `;
            lucide.createIcons();
        }

        const opcionesEstado = [
            { value: 'TRABAJO', label: 'Trabajo', color: 'green' },
            { value: 'VACACIONES', label: 'Vacaciones', color: 'blue' },
            { value: 'LIBRE', label: 'Libre', color: 'red' },
            { value: 'BAJA MÉDICA', label: 'Baja Médica', color: 'purple' },
            { value: 'FORMACIÓN', label: 'Formación', color: 'orange' },
            { value: 'LACTANCIA', label: 'Lactancia', color: 'pink' }
        ];
        
        console.log('API Key:', apiKey?.substring(0, 10) + '...');
        console.log('Base ID:', baseId);
        console.log('Table ID:', actividadDiariaTableId);
        
        function logActivityData(actividad) {
            console.log('Activity data:', {
                id: actividad.id,
                fields: actividad.fields,
                tiempo: actividad.tiempo
            });
        }
        
        async function obtenerHorasAprobadasSemanales(tiendaId) {
            try {
                const url = `https://api.airtable.com/v0/${baseId}/${tiendaSupervisorTableId}/${tiendaId}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
        
                if (!response.ok) {
                    throw new Error(`Error al obtener datos de tienda: ${response.status}`);
                }
        
                const data = await response.json();
                return parseFloat(data.fields['Horas Aprobadas'] || 0);
            } catch (error) {
                console.error('Error al obtener horas aprobadas:', error);
                return 0;
            }
        }
        
        async function obtenerHorasEfectivasSemanales(diaId, tiendaId) {
            try {
                console.log(`Calculando horas efectivas semanales para día ${diaId} y tienda ${tiendaId}`);
                
                // Constante para la tabla de actividad semanal
                const tablaActividadSemanal = "tblrrsQqHdJOF6xdy";
                
                // 1. Obtener las actividades diarias para este día
                const actividadesDiarias = await obtenerActividadesDiarias(tiendaId, diaId);
                console.log(`Actividades diarias encontradas: ${actividadesDiarias.length}`);
                
                if (!actividadesDiarias || actividadesDiarias.length === 0) {
                    console.warn('No se encontraron actividades diarias');
                    return 0;
                }
                
                // 2. Extraer los IDs de actividad semanal
                const idsActividadSemanal = [];
                actividadesDiarias.forEach(actividad => {
                    if (actividad.fields && actividad.fields['Actividad Semanal'] && 
                        Array.isArray(actividad.fields['Actividad Semanal']) && 
                        actividad.fields['Actividad Semanal'].length > 0) {
                        
                        // Agregar IDs únicos
                        actividad.fields['Actividad Semanal'].forEach(id => {
                            if (!idsActividadSemanal.includes(id)) {
                                idsActividadSemanal.push(id);
                            }
                        });
                    }
                });
                
                console.log(`IDs de actividad semanal encontrados: ${idsActividadSemanal.length}`);
                
                if (idsActividadSemanal.length === 0) {
                    console.warn('No se encontraron IDs de actividad semanal');
                    return 0;
                }
                
                // 3. Consultar las actividades semanales
                const formulaActividad = encodeURIComponent(`OR(${
                    idsActividadSemanal.map(id => `RECORD_ID()='${id}'`).join(',')
                })`);
                
                const urlActividad = `https://api.airtable.com/v0/${baseId}/${tablaActividadSemanal}?filterByFormula=${formulaActividad}`;
                console.log('URL para consultar actividades semanales:', urlActividad);
                
                const response = await fetch(urlActividad, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error al obtener actividades semanales: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`Registros de actividad semanal obtenidos: ${data.records?.length || 0}`);
                
                // 4. Sumar horas trabajadas
                let horasTotales = 0;
                data.records.forEach(record => {
                    const horas = parseFloat(record.fields['Horas Trabajadas'] || 0);
                    console.log(`Actividad semanal ${record.id}: ${horas} horas`);
                    horasTotales += horas;
                });
                
                console.log(`Total de horas efectivas semanales: ${horasTotales}`);
                return horasTotales;
            } catch (error) {
                console.error('Error al obtener horas efectivas semanales:', error);
                return 0;
            }
        }
        
        // Función para actualizar las horas efectivas semanales (con correcciones)
        async function actualizarHorasEfectivasSemanales(diaId) {
            try {
                // Obtener información de la semana a la que pertenece el día
                const response = await fetch(
                    `https://api.airtable.com/v0/${baseId}/${diasLaboralesTableId}/${diaId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Error al obtener información del día`);
                }
                
                const diaLaboral = await response.json();
                
                // CORRECCIÓN: Verificar si existe Semana Laboral de manera segura
                if (!diaLaboral.fields['Semana Laboral'] || diaLaboral.fields['Semana Laboral'].length === 0) {
                    console.warn('No se encontró información de la semana laboral para el día:', diaId);
                    // Si no hay semana laboral, mostramos 0 en el indicador
                    const horasEfectivasSemanalesElement = document.getElementById('horas-efectivas-semanales');
                    if (horasEfectivasSemanalesElement) {
                        horasEfectivasSemanalesElement.textContent = '0.0';
                    }
                    return;
                }
                
                const semanaId = diaLaboral.fields['Semana Laboral'][0];
                
                // Calcular horas efectivas semanales
                const horasEfectivasSemanales = await obtenerHorasEfectivasSemanales(semanaId, storeRecordId);
                
                // Actualizar la UI
                const horasEfectivasSemanalesElement = document.getElementById('horas-efectivas-semanales');
                if (horasEfectivasSemanalesElement) {
                    // Animar el cambio
                    const valorActual = parseFloat(horasEfectivasSemanalesElement.textContent);
                    if (valorActual !== horasEfectivasSemanales) {
                        horasEfectivasSemanalesElement.classList.add('update-flash');
                        horasEfectivasSemanalesElement.textContent = horasEfectivasSemanales.toFixed(1);
                        setTimeout(() => {
                            horasEfectivasSemanalesElement.classList.remove('update-flash');
                        }, 500);
                    }
                }
                
            } catch (error) {
                console.error('Error al actualizar horas efectivas semanales:', error);
                // En caso de error, mostramos 0 en el indicador
                const horasEfectivasSemanalesElement = document.getElementById('horas-efectivas-semanales');
                if (horasEfectivasSemanalesElement) {
                    horasEfectivasSemanalesElement.textContent = '0.0';
                }
            }
        }
        
        function calcularHorasEfectivasDiarias(actividades, tiendaData) {
            try {
                const esFrancia = tiendaData.PAIS?.toUpperCase() === 'FRANCIA';
                const incrementoPorHora = esFrancia ? 0.25 : 0.5; // 15 o 30 minutos
                
                // Obtener todas las horas disponibles
                const horasDisponibles = generarColumnasTiempo(
                    tiendaData.PAIS,
                    tiendaData.Apertura,
                    tiendaData.Cierre
                );
                
                let horasTotales = 0;
                
                // Para cada actividad (empleado)
                actividades.forEach(actividad => {
                    // Para cada hora disponible
                    horasDisponibles.forEach(hora => {
                        // Si el estado es "TRABAJO", incrementar el contador
                        if (actividad.fields[hora] === 'TRABAJO') {
                            horasTotales += incrementoPorHora;
                        }
                    });
                });
                
                return horasTotales;
            } catch (error) {
                console.error('Error al calcular horas efectivas diarias:', error);
                return 0;
            }
        }
        
        // Función para actualizar las horas efectivas diarias
        async function actualizarHorasEfectivasDiarias() {
            try {
                const modal = document.getElementById('modal-dia');
                // Si el modal no está visible, no hacemos nada
                if (!modal || modal.classList.contains('hidden')) {
                    return;
                }
        
                // Obtener el ID del día actual que se está mostrando
                const diaId = modal.getAttribute('data-dia-id');
                if (!diaId) {
                    console.warn('No se encontró el ID del día en el modal');
                    return;
                }
        
                // Obtener los datos necesarios para el cálculo
                const tiendaData = await obtenerRegistroTiendaSupervisor(storeRecordId);
                const actividades = await obtenerActividadesDiarias(storeRecordId, diaId);
        
                // Calcular horas diarias
                const horasEfectivasDiarias = calcularHorasEfectivasDiarias(actividades, tiendaData);
        
                // Actualizar la UI
                const horasEfectivasDiariasElement = document.getElementById('horas-efectivas-diarias');
                if (horasEfectivasDiariasElement) {
                    // Animar el cambio
                    const valorActual = parseFloat(horasEfectivasDiariasElement.textContent);
                    if (valorActual !== horasEfectivasDiarias) {
                        horasEfectivasDiariasElement.classList.add('update-flash');
                        horasEfectivasDiariasElement.textContent = horasEfectivasDiarias.toFixed(1);
                        setTimeout(() => {
                            horasEfectivasDiariasElement.classList.remove('update-flash');
                        }, 500);
                    }
                }
        
                // Actualizar también las horas efectivas semanales si es posible
                actualizarHorasEfectivasSemanales(diaId);
        
            } catch (error) {
                console.error('Error al actualizar horas efectivas diarias:', error);
            }
        }
                
        async function obtenerDatosSemanasLaborales() {
            try {
                const urlBase = `https://api.airtable.com/v0/${baseId}/${semanasLaboralesTableId}`;
                const requestUrl = `${urlBase}`;
                
                console.log('URL de petición a Airtable:', requestUrl);

                const respuesta = await fetch(requestUrl, {
                    headers: {
                        Authorization: `Bearer ${apiKey}`
                    }
                });

                console.log('Estado de la respuesta:', respuesta.status);
                
                if (!respuesta.ok) {
                    throw new Error(`Error en la respuesta: ${respuesta.status} ${respuesta.statusText}`);
                }

                const datos = await respuesta.json();
                console.log('Datos recibidos de Airtable:', datos);
                
                if (!datos.records || datos.records.length === 0) {
                    throw new Error('No se encontraron registros en Semanas Laborales');
                }

                console.log('Número de registros encontrados:', datos.records.length);
                return datos.records;
            } catch (error) {
                console.error("Error detallado al obtener datos de Semanas Laborales:", error);
                throw error;
            }
        }

        async function obtenerDatosTienda(recordId) {
            try {
                const url = `https://api.airtable.com/v0/${baseId}/${tiendaSupervisorTableId}/${recordId}`;
                console.log('URL de petición para tienda:', url);
                
                const response = await fetch(url, {
                    headers: { 
                        Authorization: `Bearer ${apiKey}` 
                    }
                });
                
                console.log('Estado de la respuesta de tienda:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Error al obtener tienda: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Datos de tienda recibidos:', data);
                return data;
            } catch (error) {
                console.error('Error detallado al obtener datos de tienda:', error);
                return null;
            }
        }

        
        function capitalizarPrimeraLetra(texto) {
            const palabras = texto.split(' ');
            const primeraPalabra = palabras[0];
            const año = palabras[1];
            return primeraPalabra.charAt(0).toUpperCase() + primeraPalabra.slice(1).toLowerCase() + ' ' + año;
        }

        
        function procesarDatos(records) {
            console.log('Procesando registros:', records);
            
            // Obtener años únicos
            const years = [...new Set(records.map(record => record.fields.Year))].sort();
            availableYears = years;
            
            if (!currentYear) {
                currentYear = new Date().getFullYear().toString();
                if (!years.includes(currentYear)) {
                    currentYear = years[0];
                }
            }

            // Filtrar registros por año actual
            const registrosDelAño = records.filter(record => record.fields.Year === currentYear);
            console.log('Registros del año actual:', registrosDelAño);

            // Obtener meses únicos
            const meses = [...new Set(registrosDelAño.map(record => record.fields.Mes))];
            
            // Función para convertir nombre de mes a número
            function obtenerNumeroMes(nombreMes) {
                const meses = {
                    'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3,
                    'mayo': 4, 'junio': 5, 'julio': 6, 'agosto': 7,
                    'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
                };
                // Extraer solo el nombre del mes sin el año
                const soloMes = nombreMes.split(' ')[0].toLowerCase();
                return meses[soloMes];
            }

            // Ordenar meses
            const mesesOrdenados = meses.sort((a, b) => {
                const mesNumA = obtenerNumeroMes(a);
                const mesNumB = obtenerNumeroMes(b);
                return mesNumA - mesNumB;
            });

            console.log('Meses ordenados:', mesesOrdenados);

            const mesActual = new Date().toLocaleString('es-ES', { month: 'long' }).toLowerCase();

            return {
                year: currentYear,
                months: mesesOrdenados.map(mes => ({
                    name: capitalizarPrimeraLetra(mes), // Mantenemos el formato original que incluye el año
                    isCurrent: mes.toLowerCase().startsWith(mesActual)
                }))
            };
        }

        async function obtenerSemanasLaborales(mes, año) {
            const urlBase = `https://api.airtable.com/v0/${baseId}/${semanasLaboralesTableId}`;
            
            // Filtrar solo por año para obtener todas las semanas
            const filterFormula = encodeURIComponent(`{Year}="${año}"`);
            const url = `${urlBase}?filterByFormula=${filterFormula}`;

            try {
                const respuesta = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!respuesta.ok) {
                    throw new Error(`Error: ${respuesta.statusText}`);
                }

                const datos = await respuesta.json();
                
                // Obtener el número del mes actual (1-12)
                const mesNum = obtenerNumeroMes(mes.toLowerCase()) + 1;
                
                // Filtrar las semanas que pertenecen al mes
                const semanasDelMes = datos.records.filter(record => {
                    const fechaInicio = new Date(record.fields['Fecha de Inicio']);
                    const fechaFin = new Date(record.fields['Fecha de fin']);
                    const mesInicio = fechaInicio.getMonth() + 1;
                    const mesFin = fechaFin.getMonth() + 1;
                    
                    // Una semana pertenece al mes si:
                    // - El mes está entre el mes de inicio y el mes de fin
                    // - O si el mes de inicio es igual al mes actual
                    // - O si el mes de fin es igual al mes actual
                    return (mesNum >= mesInicio && mesNum <= mesFin) || 
                        mesInicio === mesNum || 
                        mesFin === mesNum;
                });

                // Ordenar por fecha de inicio
                semanasDelMes.sort((a, b) => {
                    const fechaA = new Date(a.fields['Fecha de Inicio']);
                    const fechaB = new Date(b.fields['Fecha de Inicio']);
                    return fechaA - fechaB;
                });

                console.log(`Semanas encontradas para ${mes} ${año}:`, semanasDelMes);
                return semanasDelMes;

            } catch (error) {
                console.error("Error al obtener semanas laborales:", error);
                return [];
            }
        }

        // Función auxiliar para obtener el número de mes (0-11)
        function obtenerNumeroMes(nombreMes) {
            const meses = {
                'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3,
                'mayo': 4, 'junio': 5, 'julio': 6, 'agosto': 7,
                'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
            };
            return meses[nombreMes.split(' ')[0]];
        }

        // Función auxiliar para obtener el número de mes
        function obtenerNumeroMes(nombreMes) {
            const meses = {
                'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3,
                'mayo': 4, 'junio': 5, 'julio': 6, 'agosto': 7,
                'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
            };
            return meses[nombreMes.split(' ')[0]];
        }

        function formatearFecha(fecha) {
            if (!fecha) return '';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function renderizarVistaMes(mes, año) {
            // Ocultar el año anterior/siguiente
            document.getElementById('prev-year').style.display = 'none';
            document.getElementById('next-year').style.display = 'none';

            // Actualizar el título
            document.getElementById('lcdc-view-title').textContent = `${mes} ${año}`;

            // Mostrar el botón de volver
            const backButton = document.getElementById('lcdc-back-button');
            backButton.classList.remove('hidden');
            
            // Agregar evento al botón de volver
            backButton.onclick = () => {
                document.getElementById('prev-year').style.display = 'block';
                document.getElementById('next-year').style.display = 'block';
                backButton.classList.add('hidden');
                // Restaurar la vista de grid al volver
                const mainContainer = document.getElementById('lcdc-year-view');
                mainContainer.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';
                cargarVistaPrincipal();
            };

            // Contenedor para las semanas
            const mainContainer = document.getElementById('lcdc-year-view');
            // Cambiar a vista de mes
            mainContainer.className = 'month-view w-full space-y-3';
            mainContainer.innerHTML = '<div class="w-full space-y-3" id="weeks-container"></div>';
            
            // Cargar las semanas
            cargarSemanas(mes, año, document.getElementById('weeks-container'));
        }
        function formatearFecha(fecha) {
            if (!fecha) return '';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).replace('.', '').replace(/^(\d{1,2}) /, '$1 de ');
        }
        
                const estadosColores = {
                    'TRABAJO': '#22c55e',
                    'VACACIONES': '#3b82f6',
                    'LIBRE': '#ef4444',
                    'BAJA MÉDICA': '#8b5cf6',
                    'FORMACIÓN': '#f97316',
                    'LACTANCIA': '#ec4899'
                };

         function cargarSemanas(mes, año, container) {
            // Mostrar loader
            container.innerHTML = `
                <div class="w-full flex items-center justify-center p-8">
                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-blue-500"></i>
                </div>
            `;
            lucide.createIcons();
        
            obtenerSemanasLaborales(mes, año).then(semanas => {
                if (!semanas || semanas.length === 0) {
                    container.innerHTML = `
                        <div class="w-full text-center py-8 text-gray-500">
                            No hay semanas registradas para ${mes} ${año}
                        </div>
                    `;
                    return;
                }
        
                // Nuevo orden de días comenzando por Lunes
                const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
        
                container.innerHTML = semanas.map(week => {
                    // Ajustar las fechas para empezar en lunes y terminar en domingo
                    let fechaInicio = new Date(week.fields['Fecha de Inicio']);
                    let fechaFin = new Date(week.fields['Fecha de fin']);
                    
                    // Si la fecha de inicio es domingo, moverla al lunes siguiente
                    if (fechaInicio.getDay() === 0) {
                        fechaInicio.setDate(fechaInicio.getDate() + 1);
                    }
                    
                    // Si la fecha fin es sábado, moverla al domingo siguiente
                    if (fechaFin.getDay() === 6) {
                        fechaFin.setDate(fechaFin.getDate() + 1);
                    }
        
                    return `
                        <div class="week-container mb-4">
                            <div
                                class="week-header w-full bg-white rounded-lg shadow-sm border border-gray-200 hover:border-blue-500 transition-colors cursor-pointer"
                                data-week-id="${week.id}"
                            >
                                <div class="w-full p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-grow">
                                            <h3 class="text-lg font-medium">${week.fields.Name}</h3>
                                            <p class="text-sm text-gray-500">
                                                ${formatearFecha(fechaInicio)} - ${formatearFecha(fechaFin)}
                                            </p>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button 
                                                class="generate-pdf-button inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"
                                                data-week-id="${week.id}"
                                                data-week-name="${week.fields.Name}"
                                            >
                                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                                Generar PDF
                                            </button>
                                            <svg 
                                                xmlns="http://www.w3.org/2000/svg" 
                                                width="20" 
                                                height="20" 
                                                viewBox="0 0 24 24" 
                                                fill="none" 
                                                stroke="currentColor" 
                                                stroke-width="2" 
                                                stroke-linecap="round" 
                                                stroke-linejoin="round" 
                                                class="chevron-icon text-gray-400 transition-transform duration-200"
                                            >
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="week-content hidden mt-4">
                                <div class="lcdc-days-grid grid grid-cols-7 gap-4">
                                    ${diasSemana.map(day => `
                                        <div class="lcdc-day-card bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:border-blue-500 transition-colors overflow-hidden">
                                            <div class="day-header ${day === 'Domingo' || day === 'Sábado' ? 'bg-indigo-50 text-indigo-700' : 'bg-blue-50 text-blue-700'} p-3 text-center border-b border-blue-100">
                                                <div class="text-base font-semibold">${day}</div>
                                            </div>
                                            <div class="p-3">
                                                <div class="text-center">
                                                    <div class="text-sm text-gray-600 day-date">--</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        
                lucide.createIcons();
        
                // Agregar event listeners y manejar la expansión/colapso
                const weekHeaders = container.querySelectorAll('.week-header');
                weekHeaders.forEach((header, index) => {
                    const weekContainer = header.closest('.week-container');
                    const weekContent = weekContainer.querySelector('.week-content');
                    const chevron = header.querySelector('.chevron-icon');
                    
                    // Event listener para expandir/colapsar
                    header.addEventListener('click', function(e) {
                        if (!e.target.closest('.generate-pdf-button')) {
                            e.stopPropagation();
                            const isExpanding = weekContent.classList.contains('hidden');
                            weekContent.classList.toggle('hidden');
                            chevron.style.transform = isExpanding ? 'rotate(180deg)' : 'rotate(0deg)';
                            if (isExpanding) {
                                cargarDatosSemana(semanas[index], weekContent);
                            }
                        }
                    });
        
                    // Event listener para el botón PDF
                    const pdfButton = header.querySelector('.generate-pdf-button');
                    if (pdfButton) {
                        pdfButton.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            try {
                                const weekId = pdfButton.dataset.weekId;
                                
                                // Actualizar UI del botón
                                const originalContent = pdfButton.innerHTML;
                                pdfButton.innerHTML = `
                                    <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                    Generando...
                                `;
                                pdfButton.disabled = true;
                                lucide.createIcons();
        
                                // Obtener los datos de la semana directamente de Airtable usando el ID
                                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${semanasLaboralesTableId}/${weekId}`, {
                                    headers: {
                                        'Authorization': `Bearer ${apiKey}`
                                    }
                                });
        
                                if (!response.ok) {
                                    throw new Error('Error al obtener datos de la semana');
                                }
        
                                const semanaLaboral = await response.json();
        
                                // Generar PDF
                                const doc = await generarPDFSemana(semanaLaboral);
                                
                                // Mostrar preview
                                if (doc) {
                                    mostrarPreviewPDF(doc);
                                }
        
                                // Restaurar botón
                                pdfButton.innerHTML = originalContent;
                                pdfButton.disabled = false;
                                lucide.createIcons();
                            } catch (error) {
                                console.error('Error al generar PDF:', error);
                                alert('Error al generar el PDF. Por favor, intente nuevamente.');
                                
                                // Restaurar botón en caso de error
                                pdfButton.innerHTML = originalContent;
                                pdfButton.disabled = false;
                                lucide.createIcons();
                            }
                        });
                    }
                });
            });
        }

        // Modificación en la función cargarDatosSemana para asociar el ID del día al modal
        async function cargarDatosSemana(semana, contenedor) {
            try {
                const diasLaboralesIds = semana.fields['Dias Laborales'];
                
                if (!diasLaboralesIds || diasLaboralesIds.length === 0) {
                    console.warn('No hay días laborales asociados a esta semana');
                    return;
                }
        
                const filterFormula = `OR(${diasLaboralesIds.map(id => `RECORD_ID()='${id}'`).join(',')})`;
                const url = `https://api.airtable.com/v0/${baseId}/${diasLaboralesTableId}?filterByFormula=${encodeURIComponent(filterFormula)}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
        
                if (!response.ok) {
                    throw new Error('Error al obtener los días laborales');
                }
        
                const data = await response.json();
                const diasLaborales = data.records;
                const dayCards = contenedor.querySelectorAll('.lcdc-day-card');
        
                // Get and adjust start date in UTC
                let fechaInicioSemana = normalizarFecha(semana.fields['Fecha de Inicio']);
                
                // Map working days by weekday (0-6)
                const diasPorIndice = new Map();
                diasLaborales.forEach(diaLaboral => {
                    const fecha = normalizarFecha(diaLaboral.fields.Name);
                    // Convert day of week from 0-6 (Sunday = 0) to 0-6 (Monday = 0)
                    let indiceDia = fecha.getUTCDay();
                    indiceDia = indiceDia === 0 ? 6 : indiceDia - 1;
                    console.log(`Mapping work day: ${fecha.toISOString()} (${indiceDia})`, diaLaboral);
                    diasPorIndice.set(indiceDia, diaLaboral);
                });
        
                // Process each card
                dayCards.forEach((card, index) => {
                    const dateDiv = card.querySelector('.day-date');
                    const fecha = new Date(fechaInicioSemana);
                    fecha.setUTCDate(fechaInicioSemana.getUTCDate() + index);
                    
                    // Format date for display using UTC values
                    const diaFormateado = fecha.getUTCDate().toString().padStart(2, '0');
                    const mes = fecha.toLocaleString('es-ES', { month: 'long', timeZone: 'UTC' });
                    dateDiv.textContent = `${diaFormateado} de ${mes}`;
                    
                    console.log(`Processing card ${index}:`, {
                        fecha: fecha.toISOString(),
                        diaSemana: fecha.getUTCDay(),
                        diaLaboral: diasPorIndice.get(index)
                    });
        
                    const diaLaboral = diasPorIndice.get(index);
                    
                    if (diaLaboral) {
                        card.dataset.diaId = diaLaboral.id;
                        
                        card.addEventListener('click', async (e) => {
                            const modal = document.getElementById('modal-dia');
                            if (!modal) {
                                console.error('Modal day element not found');
                                return;
                            }
                            
                            const titulo = document.getElementById('modal-dia-titulo');
                            const dayHeader = card.querySelector('.day-header');
                            const dayDate = card.querySelector('.day-date');
                            
                            titulo.textContent = `${dayHeader.textContent.trim()} - ${dayDate.textContent}`;
                            
                            // Almacenar el ID del día en el modal para referencias futuras
                            modal.setAttribute('data-dia-id', diaLaboral.id);
                            
                            modal.classList.remove('hidden');
                            
                            await cargarDatosDelDia(diaLaboral.id, fecha);
                        });
                    }
        
                    // Mark current day if applicable
                    const hoy = normalizarFecha(new Date());
                    const estaFecha = normalizarFecha(fecha);
                    const esHoy = hoy.getTime() === estaFecha.getTime();
                    if (esHoy) {
                        const dayHeader = card.querySelector('.day-header');
                        dayHeader.classList.remove('bg-blue-50', 'bg-indigo-50');
                        dayHeader.classList.add('bg-green-50', 'text-green-700');
                    }
                });
        
            } catch (error) {
                console.error('Error loading week data:', error);
                contenedor.innerHTML = `
                    <div class="text-red-500 text-center py-4">
                        Error al cargar los datos de la semana: ${error.message}
                    </div>
                `;
            }
        }
        
        // Helper function para debug de fechas
        function debugFecha(fecha) {
            return {
                fecha: fecha.toISOString(),
                diaSemana: fecha.getDay(),
                fechaLocal: fecha.toLocaleDateString()
            };
        }

        // Función auxiliar para obtener los días laborales
        async function obtenerDiasLaborales(ids) {
            try {
                const urlBase = `https://api.airtable.com/v0/${baseId}/tblZHaVWLq5KKEmgW`;
                const filterFormula = `OR(${ids.map(id => `RECORD_ID()='${id}'`).join(',')})`;
                const url = `${urlBase}?filterByFormula=${encodeURIComponent(filterFormula)}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error al obtener días laborales: ${response.statusText}`);
                }

                const data = await response.json();
                return data.records;
            } catch (error) {
                console.error('Error al obtener días laborales:', error);
                return [];
            }
        }


        async function obtenerRegistroTiendaSupervisor(recordId) {
            try {
                if (!recordId) {
                    throw new Error('recordId es requerido');
                }

                const url = `https://api.airtable.com/v0/${baseId}/${tiendaSupervisorTableId}/${recordId}`;
                console.log('URL de obtener registro de tienda:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                console.log('Respuesta de obtener registro de tienda:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`Error al obtener datos de la tienda: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Datos obtenidos de la tienda:', data);
                
                if (!data || !data.fields) {
                    throw new Error('Respuesta de Airtable inválida');
                }

                return data.fields;
            } catch (error) {
                console.error('Error al obtener registro de tienda:', error);
                throw error;
            }
        }

        async function obtenerRegistrosActividadDiariaPorIds(ids) {
            try {
                const urlBase = `https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}`;
                const filterFormula = `OR(${ids.map(id => `RECORD_ID()='${id}'`).join(',')})`;
                const url = `${urlBase}?filterByFormula=${encodeURIComponent(filterFormula)}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error al obtener actividades diarias: ${response.statusText}`);
                }

                const data = await response.json();
                return data.records;
            } catch (error) {
                console.error('Error al obtener registros de actividad diaria:', error);
                return [];
            }
        }
                
                function renderizarVista(data) {
                    document.getElementById('lcdc-view-title').textContent = data.year;

                    const monthsContainer = document.getElementById('lcdc-year-view');
                    monthsContainer.innerHTML = data.months.map(month => `
                        <div 
                            class="lcdc-month-card relative p-6 bg-white rounded-xl shadow-sm border border-gray-200 hover:border-blue-500 transition-colors text-left cursor-pointer"
                            data-month="${month.name}"
                        >
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-medium">${capitalizarPrimeraLetra(month.name)}</h3>
                                </div>
                                <i data-lucide="calendar" class="w-5 h-5 ${month.isCurrent ? 'text-green-500' : 'text-gray-400'}"></i>
                            </div>
                            ${month.isCurrent ? `
                                <div class="absolute top-3 right-3">
                                    <span class="absolute hidden group-hover:block bg-green-100 text-green-800 text-xs px-2 py-1 rounded right-0 top-6 whitespace-nowrap">
                                        Mes actual
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');

                    // Agregar eventos de click a las tarjetas
                    document.querySelectorAll('.lcdc-month-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const monthName = card.dataset.month;
                            console.log('Mes seleccionado:', monthName); // Debug
                            const [mes, año] = monthName.split(' ');
                            console.log('Mes y año separados:', mes, año); // Debug
                            renderizarVistaMes(mes, año);
                        });
                    });

                    // Inicializar los iconos de Lucide
                    lucide.createIcons();
                }

        async function cargarVistaPrincipal() {
            mostrarCargando();
            try {
                const records = await obtenerDatosSemanasLaborales();
                const data = procesarDatos(records);
                renderizarVista(data);
            } catch (error) {
                console.error('Error al cargar vista principal:', error);
                document.getElementById('lcdc-year-view').innerHTML = `
                    <div class="col-span-full text-center text-red-600">
                        Error al cargar los datos
                    </div>
                `;
            }
        }

        function inicializarModalDia() {
            const modalHTML = `
                <div id="modal-dia" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-[9999]">
                    <div class="relative mx-auto p-5 w-full h-full my-0 flex items-center justify-center">
                        <!-- Modal Content Container with scroll -->
                        <div class="bg-gray-100 rounded-lg shadow-lg overflow-y-auto max-h-screen w-full max-w-full">
                            <!-- Header - Fixed at top -->
                            <div class="sticky top-0 bg-white border-b border-gray-200 rounded-t-lg z-10">
                                <div class="flex justify-between items-center p-4">
                                    <h2 id="modal-dia-titulo" class="text-2xl font-bold text-gray-800"></h2>
                                    <button id="cerrar-modal-dia" class="p-2 hover:bg-gray-200 rounded-full transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <!-- Indicators Section -->
                                <div class="grid grid-cols-3 gap-4 p-4 border-t border-gray-200">
                                    <div class="text-center">
                                        <div class="text-xs text-red-600 font-semibold">HORAS EFECTIVAS DIARIAS:</div>
                                        <div id="horas-efectivas-diarias" class="text-lg font-bold">0</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-red-600 font-semibold">HORAS APROBADAS SEMANALES:</div>
                                        <div id="horas-aprobadas-semanales" class="text-lg font-bold">0</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-red-600 font-semibold">HORAS EFECTIVAS SEMANALES:</div>
                                        <div id="horas-efectivas-semanales" class="text-lg font-bold">0</div>
                                    </div>
                                </div>
                            </div>
        
                            <!-- Scrollable Content -->
                            <div class="p-6 space-y-6">
                                <!-- Horarios del Día Section -->
                                <div class="bg-white rounded-lg shadow-sm p-6">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-lg font-semibold">Horarios del Día</h3>
                                        <div class="flex gap-3 flex-wrap justify-end">
                                            <span class="flex items-center gap-2">
                                                <span class="w-3 h-3 rounded bg-green-100 border border-green-200"></span>
                                                <span class="text-xs text-gray-600">Trabajo</span>
                                            </span>
                                            <span class="flex items-center gap-2">
                                                <span class="w-3 h-3 rounded bg-blue-100 border border-blue-200"></span>
                                                <span class="text-xs text-gray-600">Vacaciones</span>
                                            </span>
                                            <span class="flex items-center gap-2">
                                                <span class="w-3 h-3 rounded bg-red-100 border border-red-200"></span>
                                                <span class="text-xs text-gray-600">Libre</span>
                                            </span>
                                            <span class="flex items-center gap-2">
                                                <span class="w-3 h-3 rounded bg-purple-100 border border-purple-200"></span>
                                                <span class="text-xs text-gray-600">Baja</span>
                                            </span>
                                            <span class="flex items-center gap-2">
                                                <span class="w-3 h-3 rounded bg-orange-100 border border-orange-200"></span>
                                                <span class="text-xs text-gray-600">Formación</span>
                                            </span>
                                        </div>
                                    </div>
        
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm" id="matriz-horarios">
                                            <!-- La tabla se llenará dinámicamente -->
                                        </table>
                                    </div>
                                </div>
        
                                <!-- Tráfico por Hora Section -->
                                <div class="bg-white rounded-lg shadow-sm p-6">
                                    <h3 class="text-lg font-semibold mb-4">Tráfico por Hora</h3>
                                    <div class="space-y-4" id="trafico-por-hora">
                                        <!-- Los indicadores de tráfico se llenarán dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- Popover para selección de estado -->
                <div id="optionsPopover" class="hidden absolute bg-white shadow-lg rounded-lg p-2 z-[10000]">
                    <button onclick="selectOption('trabajo')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2">
                        <span class="w-4 h-4 rounded bg-green-100 border border-green-200"></span>
                        Trabajo
                    </button>
                    <button onclick="selectOption('vacaciones')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2">
                        <span class="w-4 h-4 rounded bg-blue-100 border border-blue-200"></span>
                        Vacaciones
                    </button>
                    <button onclick="selectOption('libre')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2">
                        <span class="w-4 h-4 rounded bg-red-100 border border-red-200"></span>
                        Libre
                    </button>
                    <button onclick="selectOption('baja')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2">
                        <span class="w-4 h-4 rounded bg-purple-100 border border-purple-200"></span>
                        Baja Médica
                    </button>
                    <button onclick="selectOption('formacion')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2">
                        <span class="w-4 h-4 rounded bg-orange-100 border border-orange-200"></span>
                        Formación
                    </button>
                </div>
            `;
        
            // Agregar el modal al body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        
            // Initialize modal events
            const modal = document.getElementById('modal-dia');
            const cerrarModal = document.getElementById('cerrar-modal-dia');
        
            cerrarModal.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }
        
        async function verificarConexionAirtable() {
            try {
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}?maxRecords=1`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
        
                console.log('Airtable connection test:', {
                    status: response.status,
                    ok: response.ok
                });
        
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Airtable connection failed:', text);
                }
        
                return response.ok;
            } catch (error) {
                console.error('Airtable connection error:', error);
                return false;
            }
        }



        async function obtenerActividadesDiarias(tiendaId, fechaId) {
            try {
                const filterFormula = encodeURIComponent(
                    `AND(
                        {record_Id (from Tienda y Supervisor)}='${tiendaId}',
                        {recordId (from Fecha)}='${fechaId}'
                    )`
                );
        
                const url = `https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}?filterByFormula=${filterFormula}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
        
                if (!response.ok) {
                    throw new Error(`Error fetching daily activities: ${response.status}`);
                }
        
                const data = await response.json();
                // Normalize dates in the response
                data.records.forEach(record => {
                    if (record.fields.Fecha) {
                        record.fields.Fecha = normalizarFecha(record.fields.Fecha);
                    }
                });
                
                return data.records;
            } catch (error) {
                console.error('Error fetching daily activities:', error);
                return [];
            }
        }

        function crearCeldaSticky(contenido, index) {
            const td = document.createElement('td');
            td.className = `py-2 ${index === 0 ? 'sticky left-0' : 'sticky left-[50px]'} z-20 bg-white`;
            td.innerHTML = contenido;
            return td;
        }
        
        function crearCeldasTiempo(actividad, tiempo, tiendaData, tr) {
            const td = document.createElement('td');
            td.className = 'px-2 py-2 border-l border-gray-200 min-w-[160px]';
            
            const select = crearSelect(
                opcionesDropdown,
                actividad.fields[tiempo] || '',
                async (e) => {
                    try {
                        await actualizarHorario(actividad, tiempo, e.target.value, tr, tiendaData.PAIS);
                    } catch (error) {
                        console.error('Error updating time:', error);
                    }
                }
            );
            
            select.dataset.tiempo = tiempo;
            td.appendChild(select);
            return td;
        }


        function crearTablaHorarios(actividades, columnasTiempo, tiendaData) {
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
        
            // Crear encabezado
            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
        
            // Definir columnas fijas con anchos ajustados
            const columnasFijas = [
                { id: 'comentarios', label: '', width: 'w-12' },
                { id: 'nombre', label: 'Nombre', width: 'w-64' },
                { id: 'horasContrato', label: 'Horas de Contrato', width: 'w-32' },
                { id: 'horasPlus', label: 'Horas +', width: 'w-28' },
                { id: 'horasMinus', label: 'Horas -', width: 'w-28' },
                { id: 'dni', label: 'DNI', width: 'w-32' },
                { id: 'asignar', label: 'ASIGNAR A TODO EL DÍA', width: 'w-48' }
            ];
        
            // Crear headers fijos
            columnasFijas.forEach(columna => {
                const th = document.createElement('th');
                th.className = `${columna.width} px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider`;
                th.textContent = columna.label;
                trHead.appendChild(th);
            });
        
            // Crear headers de tiempo con ancho aumentado
            columnasTiempo.forEach(tiempo => {
                const th = document.createElement('th');
                // Aumentar el ancho mínimo de las columnas de tiempo
                th.className = 'w-40 px-2 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider border-l border-gray-200';
                const [hora, minutos] = tiempo.split(':');
                th.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-semibold">${hora}:${minutos}</span>
                        <span class="text-xs text-gray-500">hrs</span>
                    </div>
                `;
                trHead.appendChild(th);
            });
        
            thead.appendChild(trHead);
            table.appendChild(thead);
        
            // Crear cuerpo de la tabla
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
        
            // Ordenar actividades
            const actividadesOrdenadas = [...actividades].sort((a, b) => {
                const nombreA = (a.fields.Nombre || '').toString().toUpperCase();
                const nombreB = (b.fields.Nombre || '').toString().toUpperCase();
                
                if (nombreA === 'VACANTE') return 1;
                if (nombreB === 'VACANTE') return -1;
                
                return nombreA.localeCompare(nombreB);
            });
        
            // Crear filas para cada actividad
            actividadesOrdenadas.forEach((actividad, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
                // Celda de comentarios
                const tdComentarios = document.createElement('td');
                tdComentarios.className = 'px-4 py-2';
                tdComentarios.innerHTML = `
                    <button class="p-1 hover:bg-gray-100 rounded transition-colors ${
                        actividad.fields.Observaciones ? 'text-green-500' : 'text-gray-400'
                    }">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                        </svg>
                    </button>
                `;
                tdComentarios.querySelector('button').onclick = () => mostrarModalComentarios(actividad);
                tr.appendChild(tdComentarios);
        
                // Añadir celdas fijas
                columnasFijas.slice(1).forEach(({id}) => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2';
                    if (id === 'nombre') {
                        td.innerHTML = `
                            <div class="font-medium text-gray-900 truncate">
                                ${actividad.fields.Nombre || 'N/A'}
                            </div>
                        `;
                    } else if (id === 'asignar') {
                        const selectAsignar = crearSelect(
                            opcionesDropdown.filter(op => op !== 'TRABAJO'),
                            '',
                            (e) => asignarATodoElDia(actividad.id, e.target.value, tr, columnasTiempo)
                        );
                        td.appendChild(selectAsignar);
                    } else {
                        td.textContent = actividad.fields[id] || '-';
                    }
                    tr.appendChild(td);
                });
        
                // Celdas de tiempo con dropdowns más anchos
                columnasTiempo.forEach(tiempo => {
                    const td = document.createElement('td');
                    // Aumentar el padding y establecer un ancho mínimo para las celdas de tiempo
                    td.className = 'px-2 py-2 border-l border-gray-200 min-w-[160px]';
                    const select = crearSelect(
                        opcionesDropdown,
                        actividad.fields[tiempo] || '',
                        (e) => actualizarHorario(actividad, tiempo, e.target.value, tr, tiendaData.PAIS)
                    );
                    // Asegurar que el select ocupe todo el ancho disponible
                    select.className = `w-full h-9 px-3 ${getOptionClasses(actividad.fields[tiempo] || '')}`;
                    td.appendChild(select);
                    tr.appendChild(td);
                });
        
                tbody.appendChild(tr);
            });
        
            table.appendChild(tbody);
            return table;
        }


        function calcularHorasAsignadas(actividad, columnasTiempo, pais) {
            const incremento = pais?.toUpperCase() === 'FRANCIA' ? 0.25 : 0.5;
            let horasAsignadas = 0;

            columnasTiempo.forEach(tiempo => {
                if (actividad.fields[tiempo] === 'TRABAJO') {
                    horasAsignadas += incremento;
                }
            });

            return horasAsignadas;
        }


        async function actualizarCamposHoras(tr, actividad, columnasTiempo, tiendaData) {
            // Calcular horas asignadas
            const horasAsignadas = calcularHorasAsignadas(actividad, columnasTiempo, tiendaData.PAIS);
            
            // Obtener las celdas
            const tdHorasAsignadas = tr.querySelector('td:nth-child(3)'); // Horas Asignadas
            const tdHorasMinus = tr.querySelector('td:nth-child(5)'); // Horas -
            
            // Actualizar valores en la interfaz
            if (tdHorasAsignadas) {
                tdHorasAsignadas.textContent = horasAsignadas.toFixed(1);
            }

            // Calcular Horas - (restar horas asignadas del total original)
            if (tdHorasMinus) {
                const horasMinusOriginal = parseFloat(actividad.fields['Horas -'] || 0);
                const horasMinusRestantes = horasMinusOriginal - horasAsignadas;
                tdHorasMinus.textContent = horasMinusRestantes.toFixed(1);
            }

            // Actualizar en Airtable solo las horas asignadas
            await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividad.id}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fields: {
                        'Horas': horasAsignadas
                    }
                })
            });
        }
        
        function mostrarNotificacion(mensaje, tipo) {
            const notification = document.createElement('div');
            notification.className = `
                fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 
                ${tipo === 'success' ? 'bg-green-100 border-l-4 border-green-500 text-green-700' : 
                                      'bg-red-100 border-l-4 border-red-500 text-red-700'}
            `;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        ${tipo === 'success' ? 
                            '<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' :
                            '<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>'
                        }
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${mensaje}</p>
                    </div>
                </div>
            `;
        
            document.body.appendChild(notification);
        
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }


        
        // Add a test function to verify PATCH requests are working
        async function testPatchRequest() {
            const url = `https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/test_record`;
            const options = {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fields: {
                        test_field: 'test_value'
                    }
                })
            };
        
            try {
                const response = await fetch(url, options);
                console.log('PATCH test response:', {
                    status: response.status,
                    statusText: response.statusText,
                    method: response.type
                });
            } catch (error) {
                console.error('PATCH test failed:', error);
            }
        }
        
        function formatearHora(tiempo) {
            // Ensure time is in proper format for Airtable
            const [hora, minutos] = tiempo.split(':');
            return `${hora.padStart(2, '0')}:${minutos.padStart(2, '0')}`;
        }

        function actualizarEstadoHoras(estado, valorAnterior, nuevoValor, incremento) {
            if (valorAnterior === 'TRABAJO' && nuevoValor !== 'TRABAJO') {
                estado.horasAsignadas -= incremento;
            } else if (valorAnterior !== 'TRABAJO' && nuevoValor === 'TRABAJO') {
                estado.horasAsignadas += incremento;
            }
        }
        async function obtenerDatosFilaActualizada(actividadId) {
            try {
                const url = `https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividadId}`;
                const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                },
                });

                if (!response.ok) {
                throw new Error(`Error al obtener datos de la fila: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                return data.fields;
            } catch (error) {
                console.error('Error al obtener datos de la fila:', error);
                return null;
            }
        }

        function actualizarUIFila(tr, datosFilaActualizada, columnasTiempo, tiendaData) {
                // Actualizar celdas de datos fijos
                const celdas = tr.querySelectorAll('td:nth-child(-n+6)');
                celdas.forEach((celda, index) => {
                    const campo = ['Nombre', 'Apellido', 'Horas +', 'Horas -', 'Horas', 'Horas Asignadas'][index];
                    celda.textContent = datosFilaActualizada[campo] || '-';
                });

                // Actualizar dropdowns de tiempo
                const dropdowns = tr.querySelectorAll('td:not(:nth-child(-n+6)) select');
                dropdowns.forEach((dropdown, index) => {
                    const tiempo = columnasTiempo[index];
                    const valor = datosFilaActualizada[tiempo] || '';
                    actualizarSelect(dropdown, valor);
                });

                // Actualizar estado de la actividad
                const estado = obtenerEstadoActividad(datosFilaActualizada, tiendaData);
                actualizarUIHoras(tr, estado);
            }

        function actualizarUIHoras(tr, estado) {
            const tdHorasAsignadas = tr.querySelector('.horas-asignadas');
            const tdHorasMas = tr.querySelector('.horas-mas');
            const tdHorasMenos = tr.querySelector('.horas-menos');

            if (tdHorasAsignadas) tdHorasAsignadas.textContent = estado.horasAsignadas.toFixed(1);
            if (tdHorasMas) tdHorasMas.textContent = estado.horasMasActual.toFixed(1);
            if (tdHorasMenos) tdHorasMenos.textContent = estado.horasMenosActual.toFixed(1); // Simplemente mostrar el valor de Airtable

            // Actualizar clases CSS de los dropdowns
            const timeSelects = tr.querySelectorAll('select.time-select');
            timeSelects.forEach(select => {
                const valorActual = select.value;
                select.className = `w-full p-2 rounded border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-colors ${getOptionClasses(valorActual)}`;
            });
        }
        
        function agregarEstilosActualizacion() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes updateFlash {
                    0% {
                        background-color: inherit;
                        transform: scale(1);
                    }
                    50% {
                        background-color: rgba(239, 68, 68, 0.1);
                        transform: scale(1.05);
                    }
                    100% {
                        background-color: inherit;
                        transform: scale(1);
                    }
                }
        
                .update-flash {
                    animation: updateFlash 0.5s ease;
                }
        
                /* Estilos adicionales para los indicadores de horas */
                #horas-efectivas-diarias,
                #horas-aprobadas-semanales,
                #horas-efectivas-semanales {
                    transition: all 0.3s ease;
                }
        
                .text-red-600 {
                    color: #dc2626;
                }
            `;
            document.head.appendChild(style);
        }

        // Función modificada para actualizar el horario y recalcular las horas efectivas
        async function actualizarHorario(actividad, tiempo, valor, tr, pais) {
            try {
                // Log update attempt
                console.log('Attempting to update:', {
                    activityId: actividad.id,
                    field: tiempo,
                    newValue: valor,
                    currentValue: actividad.fields[tiempo]
                });
        
                // Get the previous value before updating
                const valorAnterior = actividad.fields[tiempo];
                
                // Calculate time increment based on country
                const incremento = pais?.toUpperCase() === 'FRANCIA' ? 0.25 : 0.5;
        
                // Get current total hours from Airtable
                const responseHoras = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividad.id}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
        
                if (!responseHoras.ok) {
                    throw new Error('Error fetching current hours');
                }
        
                const dataHoras = await responseHoras.json();
                let horasActuales = parseFloat(dataHoras.fields['Horas'] || 0);
        
                // Calculate hours adjustment
                let ajusteHoras = 0;
                if (valorAnterior === 'TRABAJO' && valor !== 'TRABAJO') {
                    // If changing FROM trabajo, subtract time
                    ajusteHoras = -incremento;
                } else if (valorAnterior !== 'TRABAJO' && valor === 'TRABAJO') {
                    // If changing TO trabajo, add time
                    ajusteHoras = incremento;
                }
        
                // Calculate new total hours
                const horasNuevas = Math.max(0, horasActuales + ajusteHoras);
        
                // Update both the time slot and total hours in Airtable
                const updateData = {
                    fields: {
                        [tiempo]: valor || null,
                        'Horas': horasNuevas
                    }
                };
        
                console.log('Updating Airtable with:', updateData);
        
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividad.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
        
                if (!response.ok) {
                    const responseData = await response.text();
                    throw new Error(`Airtable error: ${response.status} - ${responseData}`);
                }
        
                // Update was successful
                actividad.fields[tiempo] = valor;
                actividad.fields['Horas'] = horasNuevas;
        
                // Update UI
                const select = tr.querySelector(`select[data-tiempo="${tiempo}"]`);
                if (select) {
                    select.value = valor;
                    select.className = `w-full h-9 px-3 rounded border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-colors ${getOptionClasses(valor)}`;
        
                    // Add success animation
                    const td = select.closest('td');
                    if (td) {
                        td.classList.remove('update-flash');
                        void td.offsetWidth;
                        td.classList.add('update-flash');
                    }
                }
        
                // Update hours display in UI if it exists
                const horasDisplay = tr.querySelector('.horas-display');
                if (horasDisplay) {
                    horasDisplay.textContent = horasNuevas.toFixed(2);
                    horasDisplay.classList.add('update-flash');
                }
        
                // Recalcular y actualizar las horas efectivas diarias
                await actualizarHorasEfectivasDiarias();
        
                // Show success notification
                mostrarNotificacion('Horario actualizado correctamente', 'success');
        
            } catch (error) {
                console.error('Update failed:', error);
                
                // Show error notification
                mostrarNotificacion('Error al actualizar el horario', 'error');
        
                // Revert select to previous value
                const select = tr.querySelector(`select[data-tiempo="${tiempo}"]`);
                if (select) {
                    select.value = actividad.fields[tiempo] || '';
                }
        
                throw error;
            }
        }

        function crearSelectorTiempo(actividad, tiempo, pais) {
            const td = document.createElement('td');
            td.className = 'py-2 px-2';
            
            const select = document.createElement('select');
            select.className = 'w-full p-2 rounded border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-colors time-select';
            select.dataset.tiempo = tiempo;
            
            const valorActual = actividad.fields[tiempo] || '';
            
            // Agregar opciones
            const opcionVacia = document.createElement('option');
            opcionVacia.value = '';
            opcionVacia.textContent = '';
            select.appendChild(opcionVacia);
            
            opcionesDropdown.forEach(opcion => {
                const option = document.createElement('option');
                option.value = opcion;
                option.textContent = opcion;
                select.appendChild(option);
            });
            
            select.value = valorActual;
            select.className += ' ' + getOptionClasses(valorActual);
            
            // Modificar el event listener
            select.addEventListener('change', async (e) => {
                const tr = e.target.closest('tr');
                const nuevoValor = e.target.value;
                const valorAnterior = valorActual;
                
                try {
                    // Actualizar el valor individual
                    const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividad.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                [tiempo]: nuevoValor
                            }
                        })
                    });

                    if (!response.ok) throw new Error('Error al actualizar');

                    // Aplicar efecto visual a todos los selectores en la fila
                    const allSelects = tr.querySelectorAll('select.time-select');
                    allSelects.forEach(sel => {
                        sel.closest('td').classList.remove('update-flash');
                        void sel.closest('td').offsetWidth;
                        sel.closest('td').classList.add('update-flash');
                    });

                    // Actualizar estado y UI con efectos
                    actividad.fields[tiempo] = nuevoValor;
                    const incremento = pais?.toUpperCase() === 'FRANCIA' ? 0.25 : 0.5;
                    const estado = estadosActividad.get(actividad.id);
                    
                    actualizarEstadoHoras(estado, valorAnterior, nuevoValor, incremento);
                    actualizarUIHoras(tr, estado);
                    await actualizarHorasTotales(actividad, tr, pais);

                } catch (error) {
                    console.error('Error al actualizar:', error);
                    actualizarSelect(select, valorActual);
                }
            });
            
            td.appendChild(select);
            return td;
        }

        

        // 2. Función para asignar a todo el día
        function asignarATodoElDia(valor, tr) {
            // Obtener todos los selectores de tiempo de la fila
            const timeSelects = tr.querySelectorAll('select.time-select');
            
            // Actualizar cada select individualmente
            timeSelects.forEach(select => {
                // Solo actualizar si el valor es diferente
                if (select.value !== valor) {
                    select.value = valor;
                    // Disparar el evento change para que se ejecute la actualización individual
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            // Añadir esta línea para actualizar los indicadores después de cambiar todos los selects
            setTimeout(actualizarHorasEfectivasDiarias, 500); // Pequeño delay para asegurar que todas las actualizaciones se completen
        }

        // 3. Función para actualizar horas en Airtable
        async function actualizarHorasEnAirtable(actividadId, estado) {
            try {
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            'Horas': estado.horasAsignadas,
                            'Horas +': estado.horasMasActual,
                            'Horas -': estado.horasMenosActual
                        }
                    })
                });

                if (!response.ok) throw new Error('Error al actualizar horas');
                return true;
            } catch (error) {
                console.error('Error al actualizar horas en Airtable:', error);
                return false;
            }
        }

        function actualizarUIHoras(tr, estado) {
            const tdHorasAsignadas = tr.querySelector('.horas-asignadas');
            const tdHorasMas = tr.querySelector('.horas-mas');
            const tdHorasMenos = tr.querySelector('.horas-menos');

            // Aplicar efecto de actualización
            [tdHorasAsignadas, tdHorasMas, tdHorasMenos].forEach(td => {
                if (td) {
                    const valorAnterior = td.textContent;
                    let nuevoValor;

                    if (td.classList.contains('horas-asignadas')) {
                        nuevoValor = estado.horasAsignadas.toFixed(1);
                    } else if (td.classList.contains('horas-mas')) {
                        nuevoValor = estado.horasMasActual.toFixed(1);
                    } else {
                        const horasMenosCalculado = estado.horasMenosActual - estado.horasAsignadas;
                        nuevoValor = horasMenosCalculado.toFixed(1);
                    }

                    if (valorAnterior !== nuevoValor) {
                        td.textContent = nuevoValor;
                        td.classList.remove('number-update');
                        // Forzar reflow
                        void td.offsetWidth;
                        td.classList.add('number-update');
                    }
                }
            });
        }


        // 6. Función de sincronización
        async function sincronizarEstadoConAirtable(actividad, tr) {
            const estado = estadosActividad.get(actividad.id);
            if (!estado || estado.updating) return;

            try {
                estado.updating = true;
                await actualizarHorasEnAirtable(actividad.id, estado);
                actualizarUIHoras(tr, estado);
            } catch (error) {
                console.error('Error al sincronizar con Airtable:', error);
            } finally {
                estado.updating = false;
            }
        }

        function actualizarSelect(select, valorActual) {
            const opciones = opcionesDropdown.map(opcion => {
                const option = document.createElement('option');
                option.value = opcion;
                option.textContent = opcion;
                return option;
            });

            select.innerHTML = '';
            opciones.forEach(opcion => select.appendChild(opcion));
            select.value = valorActual;

            // Actualizar clases CSS según el nuevo valor
            select.className = `w-full p-2 rounded border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-colors ${getOptionClasses(valorActual)}`;
        }

        function getOptionClasses(estado) {
            const baseClasses = 'custom-select w-full h-8 rounded transition-colors duration-300';
            switch (estado?.toUpperCase()) {
                case 'TRABAJO': return `${baseClasses} bg-green-100 text-green-800`;
                case 'VACACIONES': return `${baseClasses} bg-blue-100 text-blue-800`;
                case 'LIBRE': return `${baseClasses} bg-red-100 text-red-800`;
                case 'BAJA MÉDICA': return `${baseClasses} bg-purple-100 text-purple-800`;
                case 'FORMACIÓN': return `${baseClasses} bg-orange-100 text-orange-800`;
                case 'LACTANCIA': return `${baseClasses} bg-pink-100 text-pink-800`;
                default: return `${baseClasses} bg-gray-50 text-gray-800`;
            }
        }


        function mostrarModalComentarios(actividad) {
            // Crear una versión segura del objeto actividad para el evento onclick
            const actividadSegura = {
                id: actividad.id,
                fields: {
                    Observaciones: actividad.fields.Observaciones || ''
                }
            };

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Observaciones</h3>
                        <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <textarea 
                        class="w-full h-32 p-2 border rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        placeholder="Ingrese sus observaciones."
                    >${actividadSegura.fields.Observaciones}</textarea>
                    <div class="flex justify-end gap-2">
                        <button class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors" 
                                onclick="this.closest('.fixed').remove()">
                            Cancelar
                        </button>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors" 
                                onclick="guardarComentario('${actividadSegura.id}', this)">
                            Guardar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function guardarComentario(actividadId, button) {
            const modal = button.closest('.fixed');
            const textarea = modal.querySelector('textarea');
            const observaciones = textarea.value;

            try {
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            Observaciones: observaciones
                        }
                    })
                });

                if (!response.ok) throw new Error('Error al guardar comentario');

                // Cerrar modal
                modal.remove();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el comentario');
            }
        }

        async function asignarATodoElDia(actividadId, valor, fila, tiempos) {
            try {
                // Validación de parámetros
                if (!tiempos || !Array.isArray(tiempos) || tiempos.length === 0) {
                    console.error('Tiempos no válidos:', tiempos);
                    throw new Error('No se encontraron columnas de tiempo válidas');
                }

                console.log('Asignando valor', valor, 'a los tiempos:', tiempos);

                // Crear objeto con todas las actualizaciones de tiempo
                const actualizaciones = {};
                tiempos.forEach(tiempo => {
                    actualizaciones[tiempo] = valor;
                });

                // Actualizar en Airtable
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: actualizaciones
                    })
                });

                if (!response.ok) throw new Error('Error al actualizar horarios');

                // Actualizar visualmente todos los selects de la fila
                const timeSelects = fila.querySelectorAll('td:not(:nth-child(-n+6)) select');
                timeSelects.forEach(select => {
                    select.value = valor;
                    select.className = 'w-full p-2 rounded border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-colors ' + 
                                    getOptionClasses(valor);
                });

                // Actualizar Horas + y Horas -
                const horasPlus = fila.querySelector('td:nth-child(3)');
                const horasMinus = fila.querySelector('td:nth-child(4)');
                
                // Obtener el país de la tienda
                const tiendaData = await obtenerRegistroTiendaSupervisor(storeRecordId);
                const intervalo = tiendaData?.PAIS?.toUpperCase() === "FRANCIA" ? 0.25 : 0.5;
                
                const totalIntervalos = timeSelects.length;
                let nuevoValorHorasPlus = 0;
                let nuevoValorHorasMinus = 0;

                if (valor !== 'TRABAJO') {
                    nuevoValorHorasPlus = totalIntervalos * intervalo;
                    nuevoValorHorasMinus = 0;
                }

                // Actualizar visualmente las horas
                if (horasPlus) horasPlus.textContent = nuevoValorHorasPlus.toFixed(1);
                if (horasMinus) horasMinus.textContent = nuevoValorHorasMinus.toFixed(1);

                // Actualizar las horas en Airtable
                await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            'Horas +': nuevoValorHorasPlus,
                            'Horas -': nuevoValorHorasMinus
                        }
                    })
                });

            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar los horarios: ' + error.message);
            }
        }

        function obtenerEstadoActividad(actividad, tiendaData) {
            if (!actividadEstados.has(actividad.id)) {
                actividadEstados.set(actividad.id, {
                    horasMasActual: parseFloat(actividad.fields['Horas +'] || 0), // Este valor no cambiará
                    horasMenosActual: parseFloat(actividad.fields['Horas -'] || 0),
                    horasAsignadas: 0,
                    updating: false
                });
            }
            return actividadEstados.get(actividad.id);
        }


        async function guardarComentario(actividadId, button) {
            const modal = button.closest('.fixed');
            const textarea = modal.querySelector('textarea');
            const observaciones = textarea.value;

            try {
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            Observaciones: observaciones
                        }
                    })
                });

                if (!response.ok) throw new Error('Error al guardar comentario');
                
                // Cerrar modal
                modal.remove();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el comentario');
            }
        }

        function crearSelect(opciones, valorActual = '', onChange = null) {
            const select = document.createElement('select');
            select.className = `w-full h-9 px-3 rounded border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-colors ${getOptionClasses(valorActual)}`;
            
            // Empty option
            const opcionVacia = document.createElement('option');
            opcionVacia.value = '';
            opcionVacia.textContent = '';
            select.appendChild(opcionVacia);
        
            // Add options
            opcionesDropdown.forEach(valor => {
                const option = document.createElement('option');
                option.value = valor;
                option.textContent = valor;
                if (valor === valorActual) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        
            if (onChange) {
                select.addEventListener('change', onChange);
            }
        
            return select;
        }

        function crearFilaTabla(actividad, esVacante = false, columnasTiempo) {
            if (!Array.isArray(columnasTiempo)) {
                console.error('columnasTiempo no es un array:', columnasTiempo);
                return document.createElement('tr'); // Devolver una fila vacía en caso de error
            }

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            const tdComentarios = document.createElement('td');
            tdComentarios.className = 'py-2 px-4';
            tdComentarios.innerHTML = `
                <button class="p-1 hover:bg-gray-100 rounded ${
                actividad.fields.Observaciones ? 'text-green-500' : 'text-gray-400'
                }">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                </svg>
                </button>
            `;
            tdComentarios.querySelector('button').onclick = () => mostrarModalComentarios(actividad);

            // Agregar celdas fijas
            const datosIniciales = [
                actividad.fields['Nombre'] || 'N/A',
                actividad.fields['Horas de Contrato'] || 'N/A',
                actividad.fields['Horas +']?.toFixed(1) || '0.0',
                actividad.fields['Horas -']?.toFixed(1) || '0.0',
                actividad.fields['DNI'] || 'N/A'
            ];

            datosIniciales.forEach(dato => {
                const td = document.createElement('td');
                td.className = 'py-2 px-4 whitespace-nowrap text-sm text-gray-900';
                td.textContent = dato;
                tr.appendChild(td);
            });

            // Añadir selector "Asignar a todo el día"
            const tdAsignar = document.createElement('td');
            tdAsignar.className = 'py-2 px-4';
            const selectAsignar = crearSelect(
                [], 
                '', 
                async (e) => {
                    await asignarATodoElDia(actividad.id, e.target.value, tr, columnasTiempo);
                },
                true
            );
            tdAsignar.appendChild(selectAsignar);
            tr.appendChild(tdAsignar);

            // Crear celdas para cada columna de tiempo
            columnasTiempo.forEach(tiempo => {
                const td = document.createElement('td');
                td.className = 'py-2 px-2';
                const valorActual = actividad.fields[tiempo] || '';
                
                const select = crearSelect(
                    [], 
                    valorActual,
                    async (e) => {
                        await actualizarHorario(actividad.id, tiempo, e.target.value);
                    }
                );

                select.className += ' ' + getOptionClasses(valorActual);
                td.appendChild(select);
                tr.appendChild(td);
            });

            return tr;
        }


        async function cargarDatosDelDia(diaId, fecha) {
            try {
                console.log('Loading data for day:', { diaId, fecha });
                const container = document.getElementById('matriz-horarios');
                
                if (!container) {
                    console.error('Matrix container not found');
                    throw new Error('No se encontró el contenedor de la matriz de horarios');
                }
        
                // Show loading state
                container.innerHTML = `
                    <div class="flex justify-center items-center p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    </div>
                `;
        
                // Load store data
                console.log('Fetching store data for ID:', storeRecordId);
                const tiendaData = await obtenerRegistroTiendaSupervisor(storeRecordId);
                
                if (!tiendaData?.Apertura || !tiendaData?.Cierre) {
                    throw new Error('La tienda no tiene horarios definidos');
                }
                console.log('Store data retrieved:', tiendaData);
        
                // Load daily activities
                console.log('Fetching activities for day:', diaId);
                const actividades = await obtenerActividadesDiarias(storeRecordId, diaId);
                
                if (!actividades || actividades.length === 0) {
                    container.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            No hay actividades registradas para este día
                        </div>
                    `;
                    return;
                }
                console.log('Activities retrieved:', actividades.length);
        
                // Obtener información de la semana a la que pertenece el día
                const diaLaboralResponse = await fetch(
                    `https://api.airtable.com/v0/${baseId}/${diasLaboralesTableId}/${diaId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    }
                );
                
                if (!diaLaboralResponse.ok) {
                    throw new Error(`Error al obtener información del día: ${diaLaboralResponse.status}`);
                }
                
                const diaLaboral = await diaLaboralResponse.json();
                
                // CORRECCIÓN: Verificar si existe Semana Laboral antes de intentar acceder al índice 0
                let semanaId = null;
                if (diaLaboral.fields['Semana Laboral'] && diaLaboral.fields['Semana Laboral'].length > 0) {
                    semanaId = diaLaboral.fields['Semana Laboral'][0];
                } else {
                    console.warn('No se encontró información de la semana laboral');
                    // Continuar sin el ID de la semana
                }
        
                // Actualizar los indicadores de horas
                const horasAprobadasSemanales = await obtenerHorasAprobadasSemanales(storeRecordId);
                
                const horasEfectivasSemanales = await obtenerHorasEfectivasSemanales(diaId, storeRecordId);
                
                const horasEfectivasDiarias = calcularHorasEfectivasDiarias(actividades, tiendaData);
        
                // Actualizar la UI con los valores obtenidos
                document.getElementById('horas-aprobadas-semanales').textContent = horasAprobadasSemanales.toFixed(1);
                document.getElementById('horas-efectivas-semanales').textContent = horasEfectivasSemanales.toFixed(1);
                document.getElementById('horas-efectivas-diarias').textContent = horasEfectivasDiarias.toFixed(1);
        
                // Generate time columns based on store schedule
                const columnasTiempo = generarColumnasTiempo(
                    tiendaData.PAIS,
                    tiendaData.Apertura,
                    tiendaData.Cierre
                );
                console.log('Time columns generated:', columnasTiempo);
        
                // Create and render schedule table
                const tabla = crearTablaHorarios(actividades, columnasTiempo, tiendaData);
                container.innerHTML = '';
                container.appendChild(tabla);
        
                // Update traffic panel
                console.log('Updating traffic panel for day:', diaId);
                try {
                    await actualizarPanelTrafico(diaId);
                } catch (trafficError) {
                    console.error('Error loading traffic data:', trafficError);
                    const trafficContainer = document.getElementById('trafico-por-hora');
                    if (trafficContainer) {
                        trafficContainer.innerHTML = `
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="text-center text-red-500">
                                    <p class="font-medium">Error al cargar datos de tráfico</p>
                                    <p class="text-sm mt-1">${trafficError.message}</p>
                                </div>
                            </div>
                        `;
                    }
                }
        
            } catch (error) {
                console.error('Error loading day data:', error);
                
                // CORRECCIÓN: Volver a obtener la referencia a container para evitar el error
                const container = document.getElementById('matriz-horarios');
                
                // Show error state in main container
                if (container) {
                    container.innerHTML = `
                        <div class="p-4 text-center text-red-500">
                            <div class="font-medium">Error al cargar los datos</div>
                            <div class="text-sm mt-1">${error.message}</div>
                        </div>
                    `;
                }
        
                // Show error state in traffic panel
                const trafficContainer = document.getElementById('trafico-por-hora');
                if (trafficContainer) {
                    trafficContainer.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-center text-red-500">
                                <p class="font-medium">Error al cargar datos</p>
                                <p class="text-sm mt-1">No se pudieron cargar los datos del día</p>
                            </div>
                        </div>
                    `;
                }
        
                throw error;
            }
        }
        
        /**
         * Obtiene datos de tráfico para un día específico usando el rango de fechas correcto
         * @param {Object} diaLaboral - Objeto del día laboral
         * @returns {Object} Datos de tráfico procesados
         */
        async function obtenerDatosTraficoParaDia(diaLaboral) {
            try {
                // Verificar si tenemos los campos necesarios
                if (!diaLaboral.fields['Fecha Lunes Anterior'] || !diaLaboral.fields['Fecha Domingo Anterior']) {
                    console.warn('Campos Fecha Lunes Anterior o Fecha Domingo Anterior no encontrados', diaLaboral.fields);
                    return null;
                }
                
                // Obtener fechas de lunes y domingo
                const fechaLunes = new Date(diaLaboral.fields['Fecha Lunes Anterior']);
                const fechaDomingo = new Date(diaLaboral.fields['Fecha Domingo Anterior']);
                
                console.log('Obteniendo datos de tráfico para rango:', {
                    fechaLunes: fechaLunes.toISOString().split('T')[0],
                    fechaDomingo: fechaDomingo.toISOString().split('T')[0],
                    diaId: diaLaboral.id
                });
                
                // Usar la función existente obtenerDatosTrafico con estos parámetros
                const traficoData = await obtenerDatosTrafico(diaLaboral.id);
                if (!traficoData || traficoData.length === 0) {
                    console.warn('No se encontraron datos de tráfico');
                    return null;
                }
                
                // Procesar los datos usando la función existente
                const datosProcesados = procesarDatosTrafico(traficoData);
                
                // Determinar qué día de la semana es para obtener los datos específicos
                const fechaDia = new Date(diaLaboral.fields.Name);
                const diaSemanaIndex = fechaDia.getDay();
                // Ajustar para que domingo sea 6 y lunes sea 0
                const diaIndex = diaSemanaIndex === 0 ? 6 : diaSemanaIndex - 1;
                
                // Obtener los datos específicos para este día
                if (datosProcesados && datosProcesados.dias && datosProcesados.dias[diaIndex]) {
                    return datosProcesados.dias[diaIndex];
                } else {
                    console.warn('No se pudieron encontrar datos para este día específico');
                    return null;
                }
            } catch (error) {
                console.error('Error al obtener datos de tráfico para día:', error);
                return null;
            }
        }

        async function obtenerDatosTrafico(diaLaboralId) {
            try {
                console.log('Starting traffic data fetch for day:', diaLaboralId);
                const API_TOKEN = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiIxIiwianRpIjoiYmFjNzVjZGI0ZTY5M2RmNzM0ZWY0YTQ4MjVjODY1MmVlNThiYzIzNzg0Mjg4ODlhMmU4NGY0MDdjZmNmZTBmNWZhMmJhNTkzMGNmYjQ2MmUiLCJpYXQiOjE3MzAyODcyOTEuMDIxMjgyLCJuYmYiOjE3MzAyODcyOTEuMDIxMjg0LCJleHAiOjE3NjE4MjMyOTEuMDE0MzI3LCJzdWIiOiIzIiwic2NvcGVzIjpbXX0.HjA1InAAemQ7pOYdIVYl3mPbdSzTPEPvrQGQO4Z4sY1z5Z6g2DvS4q01GM9rqeusvh38GdJnuhM9tHOvkKm711j1fiNNTEcUVRVLSfK6vkRoZiDlFXTaBBWzshAL-cXYfzN4HcwSROo-xvQxO_s2Rb0QejmMbUq3jK5L1u-edu3feyMbtIgjkROLzK9C5CpO0g9uHMFfmTGF1wJ1t27yO01bqJtIRT6FgpELZCL3zVIuJtH2ZIWrf3iwmY1H3DXXq1pFPLMJxVOiZHQy5h9ODVLQO1MFFYHJWpyPM7qOLj6y08TU0AQY-ESchIGjcLrr3Gm9pmZMP2i0OfgzALt0j6ZtUn2IjU3zFqASvlZ8Ur9qMa1bJ1Ot_44ApqQ0WK-5R26qzdMt-68pZAWYuGqJB6GEM3Lx7Dj_ZKEukY9vWVi-2BLYqhzqh1KQb4fdI79lulV1lXqk6zKEUj5BBuKXK0pUJ3NWzkehUrnq8Js3LihomSvCC5Dr7gs01sOuTZUd5BIi27c-9DRJMfSExzL9BTP5KyuZJqK0_yVR1szA-vnp9pOQ-j3XA1DDQ-81TRdMNeK4cQzLENppino5mxhZHf0toFojR6YKvN-OQqKVsAwsqwi4VXQHCaQCYX9IKq8OcNrWTrsTEvwLc5fYCx7tMELn5ewZD8b29G4BJZFTGKQ';
                const BASE_URL = 'https://apiintranet.lacasadelascarcasas.es';
        
                // Get day record from Airtable
                const diaLaboralResponse = await fetch(
                    `https://api.airtable.com/v0/${baseId}/${diasLaboralesTableId}/${diaLaboralId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    }
                );
        
                if (!diaLaboralResponse.ok) {
                    throw new Error(`Error fetching day record: ${diaLaboralResponse.status}`);
                }
        
                const diaLaboral = await diaLaboralResponse.json();
                console.log('Day record retrieved:', diaLaboral);
        
                // Get start and end dates
                const startDate = new Date(diaLaboral.fields['Fecha Lunes Anterior']);
                const endDate = new Date(diaLaboral.fields['Fecha Domingo Anterior']);
                
                // Get store code
                const tiendaData = await obtenerRegistroTiendaSupervisor(storeRecordId);
                const storeCode = tiendaData["Tienda Numero"];
                
                if (!storeCode) {
                    throw new Error('Store code not found');
                }
        
                // Create array of dates between start and end
                const dates = [];
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    dates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
        
                // Fetch data for each date
                const allData = await Promise.all(dates.map(async (date) => {
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    
                    const response = await fetch(
                        `${BASE_URL}/api/v1/rrhh/get_stores_access?store_code=${storeCode}&date=${formattedDate}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`,
                                'Accept': 'application/json'
                            }
                        }
                    );
        
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
        
                    const data = await response.json();
                    return {
                        date: formattedDate,
                        dayOfWeek: date.getDay(),
                        data: data.data
                    };
                }));
        
                console.log('Traffic data received:', allData);
                return allData;
        
            } catch (error) {
                console.error('Detailed error in obtenerDatosTrafico:', error);
                throw error;
            }
        }


        function procesarDatosTrafico(datosAPI) {
            try {
                if (!Array.isArray(datosAPI)) {
                    return null;
                }
        
                // Reordered days of the week to start with Monday
                const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                
                // Modified to only use full hours
                const timeSlots = Array.from({ length: 12 }, (_, i) => {
                    const hour = i + 10; // Start from 10:00
                    return `${hour.toString().padStart(2, '0')}:00`;
                });
        
                // Initialize the data structure
                const processedData = {
                    dias: diasSemana.map(dia => ({
                        nombre: dia,
                        horas: timeSlots.map(hora => ({
                            hora,
                            entradas: 0
                        }))
                    })),
                    totalMañana: 0,
                    totalTarde: 0,
                    fechaInicio: datosAPI[0]?.date,
                    fechaFin: datosAPI[datosAPI.length - 1]?.date
                };
        
                // Fill in the data
                datosAPI.forEach(dayData => {
                    // Adjust dayOfWeek to our reordered array (0=Monday instead of 0=Sunday)
                    let diaIndex = dayData.dayOfWeek - 1;
                    if (diaIndex < 0) diaIndex = 6; // Sunday becomes index 6
                    
                    // Process the data entries
                    dayData.data.forEach(entry => {
                        // Convert the hour to the format we need
                        const hora = `${entry.hora.padStart(2, '0')}:00`;
                        const entradas = parseInt(entry.entradas);
                        
                        const horaIndex = timeSlots.indexOf(hora);
                        if (horaIndex !== -1) {
                            processedData.dias[diaIndex].horas[horaIndex].entradas = entradas;
        
                            // Update totals based on morning/afternoon
                            const hour = parseInt(entry.hora);
                            if (hour < 14) {
                                processedData.totalMañana += entradas;
                            } else {
                                processedData.totalTarde += entradas;
                            }
                        }
                    });
                });
        
                console.log('Processed data:', processedData); // Debug log
                return processedData;
            } catch (error) {
                console.error('Error procesando datos de tráfico:', error);
                return null;
            }
        }


        function renderizarGraficoTrafico(datos) {
            const container = document.getElementById('trafico-por-hora');
            if (!container) return;
        
            if (!datos || !datos.dias) {
                container.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow">
                        <h2 class="text-lg font-semibold mb-4">Tráfico por Hora</h2>
                        <p class="text-gray-500 text-center">No hay datos de tráfico disponibles</p>
                    </div>
                `;
                return;
            }
        
            // New color function with 10 different color ranges based on increments of 10
            const getTrafficColor = (value) => {
                const ranges = [
                    { max: 10, color: 'bg-blue-50 text-blue-800' },       // 0-10
                    { max: 20, color: 'bg-cyan-50 text-cyan-800' },       // 10-20
                    { max: 30, color: 'bg-teal-50 text-teal-800' },       // 20-30
                    { max: 40, color: 'bg-green-50 text-green-800' },     // 30-40
                    { max: 50, color: 'bg-lime-50 text-lime-800' },       // 40-50
                    { max: 60, color: 'bg-yellow-50 text-yellow-800' },   // 50-60
                    { max: 70, color: 'bg-amber-50 text-amber-800' },     // 60-70
                    { max: 80, color: 'bg-orange-50 text-orange-800' },   // 70-80
                    { max: 90, color: 'bg-red-50 text-red-800' },         // 80-90
                    { max: Infinity, color: 'bg-rose-50 text-rose-800' }  // 90+
                ];
        
                for (const range of ranges) {
                    if (value < range.max) {
                        return range.color;
                    }
                }
                return ranges[ranges.length - 1].color; // Default to last color if over all ranges
            };
        
            const timeSlots = datos.dias[0].horas.map(h => h.hora);
            
            // Create the legend items based on the color ranges
            const legendItems = [
                { range: '0-10', color: 'bg-blue-50 border-blue-200' },
                { range: '10-20', color: 'bg-cyan-50 border-cyan-200' },
                { range: '20-30', color: 'bg-teal-50 border-teal-200' },
                { range: '30-40', color: 'bg-green-50 border-green-200' },
                { range: '40-50', color: 'bg-lime-50 border-lime-200' },
                { range: '50-60', color: 'bg-yellow-50 border-yellow-200' },
                { range: '60-70', color: 'bg-amber-50 border-amber-200' },
                { range: '70-80', color: 'bg-orange-50 border-orange-200' },
                { range: '80-90', color: 'bg-red-50 border-red-200' },
                { range: '90+', color: 'bg-rose-50 border-rose-200' }
            ];
        
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="border-b border-gray-200 bg-white px-6 py-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Tráfico por Hora</h2>
                            <div class="flex gap-6">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-gray-500">Inicio:</span>
                                    <span class="text-sm font-semibold text-gray-700">${new Date(datos.fechaInicio).toLocaleDateString()}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-gray-500">Fin:</span>
                                    <span class="text-sm font-semibold text-gray-700">${new Date(datos.fechaFin).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="sticky-column px-4 py-3 border-b border-r border-gray-200 bg-gray-50">
                                        <span class="text-sm font-semibold text-gray-700">Entradas</span>
                                    </th>
                                    ${timeSlots.map(time => `
                                        <th class="px-3 py-3 border-b border-r border-gray-200">
                                            <span class="text-sm font-semibold text-gray-700">${time}</span>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${datos.dias.map((dia, index) => `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="sticky-column px-4 py-2 border-r border-gray-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                            <span class="text-sm font-medium text-gray-700">${dia.nombre}</span>
                                        </td>
                                        ${dia.horas.map(hora => `
                                            <td class="px-2 py-2 border-r border-b border-gray-200">
                                                <div class="traffic-cell ${getTrafficColor(hora.entradas)} rounded-md px-3 py-1.5">
                                                    <span class="text-sm font-medium">${hora.entradas}</span>
                                                </div>
                                            </td>
                                        `).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100">
                                    <td colspan="${Math.ceil(timeSlots.length/2)}" class="px-4 py-3 border-t border-gray-200">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-semibold text-gray-700">TOTAL ENTRADAS MAÑANAS:</span>
                                            <span class="text-sm font-bold text-gray-900">${datos.totalMañana}</span>
                                        </div>
                                    </td>
                                    <td colspan="${Math.floor(timeSlots.length/2)}" class="px-4 py-3 border-t border-l border-gray-200">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-semibold text-gray-700">TOTAL ENTRADAS TARDES:</span>
                                            <span class="text-sm font-bold text-gray-900">${datos.totalTarde}</span>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
        
                    <div class="px-6 py-4 border-t border-gray-200">
                        <div class="flex flex-wrap justify-end gap-3">
                            ${legendItems.map(item => `
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded ${item.color}"></div>
                                    <span class="text-xs text-gray-600">${item.range}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        async function actualizarPanelTrafico(diaId) {
            console.log('Starting traffic panel update for day:', diaId);
            const container = document.getElementById('trafico-por-hora');
            if (!container) {
                console.error('Traffic container not found');
                return;
            }
        
            try {
                // Show loading state
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-center items-center h-32">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        </div>
                    </div>
                `;
        
                const datos = await obtenerDatosTrafico(diaId);
                console.log('Traffic data retrieved:', datos);
                
                const datosProcesados = procesarDatosTrafico(datos);
                console.log('Processed traffic data:', datosProcesados);
                
                renderizarGraficoTrafico(datosProcesados);
            } catch (error) {
                console.error('Error updating traffic panel:', error);
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-center text-red-500">
                            <p class="font-medium">Error al cargar datos de tráfico</p>
                            <p class="text-sm mt-1">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        function normalizarFecha(fecha) {
            if (!fecha) return null;
            // Create date in UTC
            const date = new Date(fecha);
            // Reset the time to midnight UTC
            return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
        }

        function crearFilaTabla(actividad, esVacante, columnasTiempo) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            // Celda de comentarios (sticky)
            const tdComentarios = crearCeldaSticky(`
                <button class="p-1 hover:bg-gray-100 rounded ${
                    actividad.fields.Observaciones ? 'text-green-500' : 'text-gray-400'
                }">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                    </svg>
                </button>
            `, 0);
            tdComentarios.querySelector('button').onclick = () => mostrarModalComentarios(actividad);

            // Celda de nombre (sticky)
            const nombreDisplay = esVacante ? 'VACANTE' : 
                (Array.isArray(actividad.fields.Nombre) ? actividad.fields.Nombre[0] : actividad.fields.Nombre);
            const tdNombre = crearCeldaSticky(`
                <div class="py-2 px-4 font-medium">
                    ${nombreDisplay}
                </div>
            `, 1);

            // Añadir celdas fijas
            tr.appendChild(tdComentarios);
            tr.appendChild(tdNombre);

            // Añadir otras celdas normales
            const celdasNormales = [
                { campo: 'Horas +', clase: 'text-center' },
                { campo: 'Horas -', clase: 'text-center' },
                { campo: 'DNI', clase: '' }
            ];


            celdasNormales.forEach(({campo, clase}) => {
                const td = document.createElement('td');
                td.className = `py-2 px-4 ${clase}`;
                td.textContent = esVacante && campo === 'DNI' ? '-' : (actividad.fields[campo] || '-');
                tr.appendChild(td);
            });

            // Añadir selector "Asignar a todo el día"
            const tdAsignar = document.createElement('td');
            tdAsignar.className = 'py-2 px-4';
            const selectAsignar = crearSelect(opcionesEstado, '', 
                (e) => asignarATodoElDia(actividad.id, e.target.value, tr));
            tdAsignar.appendChild(selectAsignar);
            tr.appendChild(tdAsignar);

            // Añadir celdas de tiempo
            columnasTiempo.forEach(tiempo => {
                const td = document.createElement('td');
                td.className = 'p-1';
                td.style.minWidth = '140px'; // Asegura que las celdas de datos también sean más anchas
                td.style.width = '140px';
                const select = crearSelect([], actividad.fields[tiempo] || '',
                    (e) => actualizarHorario(actividad.id, tiempo, e.target.value));
                
                select.style.width = '100%'; // Asegura que el select ocupe todo el espacio disponible
                select.className += ' ' + getOptionClasses(actividad.fields[tiempo] || '');
                
                td.appendChild(select);
                tr.appendChild(td);
            });

            return tr;
        }

        // Función para calcular y actualizar las horas totales
        async function actualizarHorasTotales(actividad, tr, pais) {
            try {
                // Obtener todos los selectores de tiempo de la fila
                const timeSelects = tr.querySelectorAll('select.time-select');
                const incremento = pais?.toUpperCase() === 'FRANCIA' ? 0.25 : 0.5;
                
                // Calcular total de horas trabajadas
                let horasTotales = 0;
                timeSelects.forEach(select => {
                    if (select.value === 'TRABAJO') {
                        horasTotales += incremento;
                    }
                });

                // Actualizar en Airtable
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${actividadDiariaTableId}/${actividad.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            'Horas': horasTotales
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al actualizar horas totales');
                }

                console.log(`Horas totales actualizadas: ${horasTotales}`);
                return horasTotales;

            } catch (error) {
                console.error('Error al actualizar horas totales:', error);
                throw error;
            }
        }

        // Función helper para obtener las clases de estilo según el estado
        function getOptionClasses(estado) {
            const baseClasses = 'custom-select w-full h-8 rounded transition-colors duration-150';
            switch (estado?.toUpperCase()) {
                case 'TRABAJO': return `${baseClasses} bg-green-100`;
                case 'VACACIONES': return `${baseClasses} bg-blue-100`;
                case 'LIBRE': return `${baseClasses} bg-red-100`;
                case 'BAJA MÉDICA': return `${baseClasses} bg-purple-100`;
                case 'FORMACIÓN': return `${baseClasses} bg-orange-100`;
                case 'LACTANCIA': return `${baseClasses} bg-pink-100`;
                default: return `${baseClasses} bg-gray-50`;
            }
        }

        function generarColumnasTiempo(pais, apertura, cierre) {
            if (!apertura || !cierre) {
                console.error('Horarios inválidos:', { apertura, cierre });
                return [];
            }

            const columnas = [];
            const increment = pais && pais.toUpperCase() === "FRANCIA" ? 15 : 30;
            
            try {
                // Convertir horarios a minutos para facilitar comparación
                const [horaApertura, minApertura] = apertura.split(':').map(Number);
                const [horaCierre, minCierre] = cierre.split(':').map(Number);
                const minutosApertura = horaApertura * 60 + minApertura;
                const minutosCierre = horaCierre * 60 + minCierre;

                for (let minutos = minutosApertura; minutos <= minutosCierre; minutos += increment) {
                    const hora = Math.floor(minutos / 60);
                    const min = minutos % 60;
                    columnas.push(`${hora.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
                }

                console.log('Columnas generadas:', columnas);
                return columnas;
            } catch (error) {
                console.error('Error al generar columnas de tiempo:', error);
                return [];
            }
        }

                        
        
        async function inicializarCalendario(storeRecordId) {
            if (!storeRecordId) {
                showErrorState('ID de tienda no válido');
                return;
            }
        
            mostrarCargando();
            
            try {
                // Verify store
                const tiendaData = await obtenerDatosTienda(storeRecordId);
                if (!tiendaData) {
                    throw new Error('No se encontró la tienda especificada');
                }
        
                // Get labor weeks data
                const records = await obtenerDatosSemanasLaborales();
                
                // Process and display data
                const data = procesarDatos(records);
                renderizarVista(data);
        
                // Configure year navigation
                const configureYearNavigation = () => {
                    const prevYearBtn = document.getElementById('prev-year');
                    const nextYearBtn = document.getElementById('next-year');
                    
                    const currentIndex = availableYears.indexOf(currentYear);
                    
                    // Disable buttons if no more years
                    prevYearBtn.disabled = currentIndex <= 0;
                    nextYearBtn.disabled = currentIndex >= availableYears.length - 1;
                    
                    // Update visual styles
                    prevYearBtn.classList.toggle('opacity-50', currentIndex <= 0);
                    nextYearBtn.classList.toggle('opacity-50', currentIndex >= availableYears.length - 1);
                };
        
                // Set up event listeners
                document.getElementById('prev-year').addEventListener('click', () => {
                    const currentIndex = availableYears.indexOf(currentYear);
                    if (currentIndex > 0) {
                        currentYear = availableYears[currentIndex - 1];
                        const newData = procesarDatos(records);
                        renderizarVista(newData);
                        configureYearNavigation();
                    }
                });
        
                document.getElementById('next-year').addEventListener('click', () => {
                    const currentIndex = availableYears.indexOf(currentYear);
                    if (currentIndex < availableYears.length - 1) {
                        currentYear = availableYears[currentIndex + 1];
                        const newData = procesarDatos(records);
                        renderizarVista(newData);
                        configureYearNavigation();
                    }
                });
        
                // Initial navigation configuration
                configureYearNavigation();
        
            } catch (error) {
                console.error('Error al inicializar el calendario:', error);
                showErrorState(error.message);
            }
        }

        async function obtenerDiasLaborales(ids) {
            try {
                if (!ids || ids.length === 0) {
                    throw new Error('No se proporcionaron IDs de días laborales');
                }

                const urlBase = `https://api.airtable.com/v0/${baseId}/tblZHaVWLq5KKEmgW`;
                const filterFormula = `OR(${ids.map(id => `RECORD_ID()='${id}'`).join(',')})`;
                const url = `${urlBase}?filterByFormula=${encodeURIComponent(filterFormula)}`;

                console.log('URL para obtener días laborales:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error al obtener días laborales: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Datos de días laborales:', data);
                return data.records;
            } catch (error) {
                console.error('Error al obtener días laborales:', error);
                return [];
            }
        }
        
        const html2canvasConfig = {
            scale: 2,
            logging: false,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            windowWidth: 1920, // Ancho fijo para mejor consistencia
            onclone: (document) => {
                // Ajustes adicionales al clonar el documento
                const styles = document.createElement('style');
                styles.textContent = `
                    th, td { font-family: Arial, sans-serif !important; }
                    .transform { transform-origin: center; }
                `;
                document.head.appendChild(styles);
            }
        };

       /**
         * Genera un PDF con el horario semanal en un diseño mejorado
         * @param {Object} semanaLaboral - Objeto de la semana laboral desde Airtable
         * @returns {Object} Documento PDF generado
         */
        async function generarPDFSemana(semanaLaboral) {
            // Crear contenedor temporal para generar HTML
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            document.body.appendChild(tempContainer);
        
            try {
                console.log('Generando PDF para semana:', semanaLaboral.id);
                
                // Inicializar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
        
                // Obtener dimensiones del documento
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                // Configurar márgenes
                const margins = {
                    top: 15,
                    bottom: 15,
                    left: 10,
                    right: 10
                };
        
                // Obtener datos de la tienda
                const tiendaData = await obtenerRegistroTiendaSupervisor(storeRecordId);
                
                // Obtener días laborales ordenados cronológicamente
                const diasLaborales = (await obtenerDiasLaborales(semanaLaboral.fields['Dias Laborales']))
                    .sort((a, b) => new Date(a.fields.Name) - new Date(b.fields.Name));
        
                // Crear una página para cada día de la semana
                for (let i = 0; i < diasLaborales.length; i++) {
                    // Añadir nueva página si no es la primera
                    if (i > 0) doc.addPage();
                    
                    const diaLaboral = diasLaborales[i];
                    
                    // Obtener actividades diarias para este día
                    const actividades = await obtenerActividadesDiarias(storeRecordId, diaLaboral.id);
                    
                    // Crear el contenedor HTML para esta página con diseño mejorado
                    const pageContainer = document.createElement('div');
                    pageContainer.style.width = '1400px';
                    pageContainer.style.background = 'white';
                    pageContainer.style.padding = '20px';
                    pageContainer.style.fontFamily = 'Arial, sans-serif';
                    
                    // Generar el HTML para esta página
                    pageContainer.innerHTML = await generarHTMLPaginaDia(
                        diaLaboral, 
                        tiendaData, 
                        actividades, 
                        semanaLaboral
                    );
                    
                    tempContainer.innerHTML = '';
                    tempContainer.appendChild(pageContainer);
        
                    // Convertir HTML a imagen con html2canvas
                    const canvas = await html2canvas(pageContainer, {
                        scale: 2.5,
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        width: 1400,
                        height: pageContainer.offsetHeight
                    });
        
                    // Calcular dimensiones manteniendo la relación de aspecto
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const imgWidth = pageWidth - (margins.left + margins.right);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
                    // Añadir imagen al PDF
                    doc.addImage(
                        imgData,
                        'JPEG',
                        margins.left,
                        margins.top,
                        imgWidth,
                        imgHeight,
                        undefined,
                        'FAST'
                    );
                    
                    // Añadir pie de página con número de página
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(
                        `Página ${i + 1} de ${diasLaborales.length}`, 
                        pageWidth - margins.right, 
                        pageHeight - 5, 
                        { align: 'right' }
                    );
                }
        
                // Limpiar y devolver el documento PDF
                document.body.removeChild(tempContainer);
                return doc;
        
            } catch (error) {
                // Manejo de errores y limpieza
                console.error('Error al generar PDF:', error);
                if (tempContainer && tempContainer.parentNode) {
                    document.body.removeChild(tempContainer);
                }
                throw error;
            }
        }
        
        /**
         * Genera el contenido HTML para una página del PDF correspondiente a un día
         * @param {Object} diaLaboral - Objeto del día laboral
         * @param {Object} tiendaData - Datos de la tienda
         * @param {Array} actividades - Actividades del día
         * @param {Object} semanaLaboral - Datos de la semana
         * @returns {String} HTML para la página del día
         */
        async function generarHTMLPaginaDia(diaLaboral, tiendaData, actividades, semanaLaboral) {
            try {
                // Formatear la fecha
                const fechaDia = new Date(diaLaboral.fields.Name);
                const nombreDiaSemana = fechaDia.toLocaleDateString('es-ES', { weekday: 'long' });
                const fechaFormateada = fechaDia.toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Obtener datos de tráfico para este día usando la función mejorada
                const datosTraficoDia = await obtenerDatosTraficoParaDia(diaLaboral);
                
                console.log('Actividades encontradas para el día:', actividades.length);
                
                // Generar el HTML completo para esta página, sin las métricas en tarjetas
                return `
                    <div style="margin-bottom: 16px; border-bottom: 2px solid #1e40af; display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px;">
                        <div>
                            <div style="display: flex; align-items: center;">
                                <img src="https://assets.softr-files.com/applications/d2d6e043-e9ce-4611-bde6-9b4adce68439/assets/b958b590-60c1-4d04-b771-eda033d0fc92.png" 
                                     style="width: 36px; height: 36px; margin-right: 8px;">
                                <h1 style="margin: 0; font-size: 22px; color: #1e40af;">HORARIOS ${nombreDiaSemana.toUpperCase()}</h1>
                            </div>
                            <div style="font-size: 13px; color: #4b5563; margin-top: 3px;">
                                ${fechaFormateada} - Semana: ${semanaLaboral.fields.Name || 'N/A'}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 16px; font-weight: bold;">${tiendaData.TIENDA || 'N/A'}</div>
                            <div style="font-size: 13px; color: #4b5563;">Plaza ${tiendaData['N°'] || 'N/A'}</div>
                        </div>
                    </div>
                    
                    <!-- Tabla de horarios (ahora incluye todos los empleados) -->
                    ${generarTablaHorarios(actividades, tiendaData, datosTraficoDia)}
                `;
            } catch (error) {
                console.error('Error al generar HTML de la página:', error);
                return `
                    <div style="padding: 20px; color: #dc2626; text-align: center;">
                        Error al generar la vista: ${error.message}
                    </div>
                `;
            }
        }

        
        /**
         * Calcula las métricas para un día específico
         * @param {Array} actividades - Actividades del día
         * @param {Object} tiendaData - Datos de la tienda
         * @returns {Object} Métricas calculadas
         */
        function calcularMetricasDia(actividades, tiendaData) {
            let totalHorasPlus = 0;
            let totalHorasMinus = 0;
            let horasProgramadas = 0;
            let entradasEstimadas = 0;
            
            // Calcular totales de horas + y horas -
            actividades.forEach(actividad => {
                totalHorasPlus += parseFloat(actividad.fields['Horas +'] || 0);
                totalHorasMinus += parseFloat(actividad.fields['Horas -'] || 0);
                
                // Calcular horas programadas contando estados "TRABAJO"
                const columnasTiempo = generarColumnasTiempo(tiendaData.PAIS, tiendaData.Apertura, tiendaData.Cierre);
                const incremento = tiendaData.PAIS?.toUpperCase() === 'FRANCIA' ? 0.25 : 0.5; // 15 o 30 minutos
                
                columnasTiempo.forEach(tiempo => {
                    if (actividad.fields[tiempo] === 'TRABAJO') {
                        horasProgramadas += incremento;
                    }
                });
            });
            
            // Intentar obtener las entradas estimadas del tráfico
            // Nota: En una implementación real, esto puede obtenerse de la API de tráfico
            // Para simplificar, usamos un valor aproximado basado en las horas programadas
            entradasEstimadas = Math.round(horasProgramadas * 3.5);
            
            return {
                totalHorasPlus,
                totalHorasMinus,
                horasProgramadas,
                entradasEstimadas
            };
        }
        
        /**
         * Genera HTML para la tabla de horarios incluyendo ESTIMADO y ATENCIÓN
         * @param {Array} actividades - Actividades del día
         * @param {Object} tiendaData - Datos de la tienda
         * @param {Object} datosTraficoDia - Datos de tráfico para el día
         * @returns {String} HTML de la tabla
         */
        function generarTablaHorarios(actividades, tiendaData, datosTraficoDia) {
            // Generar columnas de tiempo basadas en horarios de la tienda
            const horarios = generarColumnasTiempo(tiendaData.PAIS, tiendaData.Apertura, tiendaData.Cierre);
            
            // Filtrar solo empleados con al menos un turno de trabajo
            const empleadosConTrabajo = actividades.filter(actividad => {
                return Object.keys(actividad.fields).some(campo => 
                    horarios.includes(campo) && actividad.fields[campo] === 'TRABAJO');
            });
            
            console.log('Empleados con trabajo:', empleadosConTrabajo.length, 'de', actividades.length, 'actividades');
            
            // Obtener valores de los campos exactamente como aparecen en el log
            const crecimiento = parseFloat(tiendaData.Crecimiento || 0);
            const atencionDeseada = parseFloat(tiendaData["Atención Deseada"] || 2);
            
            // Si no hay empleados con trabajo, mostrar mensaje pero incluir ESTIMADO y ATENCIÓN
            const sinEmpleadosHTML = `
                <tr>
                    <td colspan="${5 + horarios.length}" style="padding: 15px; text-align: center; background-color: #f8fafc; color: #64748b;">
                        No hay empleados con turnos de trabajo para este día
                    </td>
                </tr>
            `;
            
            // Crear fila de totales
            const totalEmpleados = empleadosConTrabajo.length;
            const totalHorasPlus = empleadosConTrabajo.reduce((sum, act) => sum + parseFloat(act.fields['Horas +'] || 0), 0).toFixed(1);
            const totalHorasMinus = empleadosConTrabajo.reduce((sum, act) => sum + parseFloat(act.fields['Horas -'] || 0), 0).toFixed(1);
            
            // Crear filas ESTIMADO y ATENCIÓN con los cálculos por hora
            const estimadoAtención = calcularEstimadoAtencion(horarios, datosTraficoDia, crecimiento, atencionDeseada);
            
            // Construir HTML de la tabla
            return `
                <div style="overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background-color: #1e40af; color: white;">
                                <th style="padding: 6px 8px; text-align: left; position: sticky; left: 0; background-color: #1e40af; z-index: 10; width: 100px;">Empleado</th>
                                <th style="padding: 6px 4px; text-align: center; width: 40px;">Categoría</th>
                                <th style="padding: 6px 4px; text-align: center; width: 40px;">H.Contrato</th>
                                <th style="padding: 6px 4px; text-align: center; width: 30px;">Horas +</th>
                                <th style="padding: 6px 4px; text-align: center; width: 30px;">Horas -</th>
                                ${horarios.map(hora => `
                                    <th style="padding: 4px 2px; text-align: center; width: 30px; font-size: 10px;">${hora}</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${empleadosConTrabajo.length > 0 ? empleadosConTrabajo.map((actividad, index) => {
                                // Datos del empleado
                                const categoria = actividad.fields.CATEGORIA || 'N/A';
                                const horasContrato = actividad.fields['Horas de Contrato'] || 'N/A';
                                const horasPlus = parseFloat(actividad.fields['Horas +'] || 0).toFixed(1);
                                const horasMinus = parseFloat(actividad.fields['Horas -'] || 0).toFixed(1);
                                
                                return `
                                    <tr style="background-color: ${index % 2 === 0 ? '#f8fafc' : '#ffffff'}; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 4px 8px; text-align: left; position: sticky; left: 0; background-color: ${index % 2 === 0 ? '#f8fafc' : '#ffffff'}; font-weight: 500; z-index: 5;">
                                            ${actividad.fields.Nombre || 'N/A'}
                                        </td>
                                        <td style="padding: 4px 2px; text-align: center;">
                                            ${categoria}
                                        </td>
                                        <td style="padding: 4px 2px; text-align: center;">
                                            ${horasContrato}
                                        </td>
                                        <td style="padding: 4px 2px; text-align: center; color: ${parseFloat(horasPlus) > 0 ? '#16a34a' : '#64748b'}; font-weight: ${parseFloat(horasPlus) > 0 ? 'bold' : 'normal'};">
                                            ${horasPlus}
                                        </td>
                                        <td style="padding: 4px 2px; text-align: center; color: ${parseFloat(horasMinus) > 0 ? '#dc2626' : '#64748b'}; font-weight: ${parseFloat(horasMinus) > 0 ? 'bold' : 'normal'};">
                                            ${horasMinus}
                                        </td>
                                        ${horarios.map(hora => {
                                            const estado = actividad.fields[hora] || '';
                                            const colorFondo = obtenerColorEstado(estado);
                                            
                                            return `
                                                <td style="padding: 2px; text-align: center; vertical-align: middle; border-right: 1px solid #e2e8f0;">
                                                    ${estado ? `
                                                        <div style="display: inline-block; width: 15px; height: 15px; border-radius: 3px; background-color: ${colorFondo};">
                                                        </div>
                                                    ` : ''}
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `;
                            }).join('') : sinEmpleadosHTML}
                            <tr style="background-color: #e2e8f0; font-weight: bold; border-top: 2px solid #94a3b8;">
                                <td style="padding: 6px 8px; text-align: left; position: sticky; left: 0; background-color: #e2e8f0; z-index: 5;">
                                    TOTAL
                                </td>
                                <td style="padding: 6px 2px; text-align: center;">
                                    ${totalEmpleados}
                                </td>
                                <td style="padding: 6px 2px; text-align: center;">
                                    -
                                </td>
                                <td style="padding: 6px 2px; text-align: center;">
                                    ${totalHorasPlus}
                                </td>
                                <td style="padding: 6px 2px; text-align: center;">
                                    ${totalHorasMinus}
                                </td>
                                ${horarios.map(() => `
                                    <td style="padding: 6px 2px; text-align: center; border-right: 1px solid #cbd5e1;">-</td>
                                `).join('')}
                            </tr>
                            <!-- Fila ESTIMADO -->
                            <tr style="background-color: #283e69; color: white; font-weight: medium;">
                                <td style="padding: 6px 8px; text-align: left; position: sticky; left: 0; background-color: #283e69; z-index: 5;">
                                    ESTIMADO
                                </td>
                                <td style="padding: 4px 2px; text-align: center;" colspan="4">
                                    -
                                </td>
                                ${horarios.map((hora, index) => `
                                    <td style="padding: 4px 2px; text-align: center; border-right: 1px solid #3b5280;">
                                        ${estimadoAtención.estimado[index] !== undefined ? estimadoAtención.estimado[index] : '1'}
                                    </td>
                                `).join('')}
                            </tr>
                            <!-- Fila ATENCIÓN - Ahora muestra el valor completo de Atención Deseada -->
                            <tr style="background-color: #1e3464; color: white; font-weight: medium;">
                                <td style="padding: 6px 8px; text-align: left; position: sticky; left: 0; background-color: #1e3464; z-index: 5;">
                                    ATENCIÓN
                                </td>
                                <td style="padding: 4px 2px; text-align: center;" colspan="4">
                                    -
                                </td>
                                ${horarios.map(() => `
                                    <td style="padding: 4px 2px; text-align: center; border-right: 1px solid #2c4b91;">
                                        ${Math.round(atencionDeseada)}
                                    </td>
                                `).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        
        /**
         * Calcula los valores ESTIMADO y ATENCIÓN para cada hora
         * @param {Array} horarios - Lista de horas de la tabla
         * @param {Object} datosTraficoDia - Datos de tráfico para el día
         * @param {Number} crecimiento - Porcentaje de crecimiento (en decimal)
         * @param {Number} atencionDeseada - Valor de atención deseada
         * @returns {Object} Objeto con arrays de valores para ESTIMADO y ATENCIÓN
         */
        function calcularEstimadoAtencion(horarios, datosTraficoDia, crecimiento, atencionDeseada) {
            // Inicializar arrays de resultados
            const estimado = [];
            
            // Asegurarnos de que atencionDeseada sea un número válido y usar fórmula correcta
            const atencionMedia = Math.max(atencionDeseada / 2, 1); // Usar 1 como mínimo para evitar divisiones por cero
            
            console.log('Cálculo de ESTIMADO:');
            console.log('- Atención Deseada:', atencionDeseada);
            console.log('- Atención Media calculada:', atencionMedia);
            console.log('- Crecimiento (decimal):', crecimiento);
            
            // Verificar la estructura de datos de tráfico
            if (!datosTraficoDia) {
                console.warn('Datos de tráfico no disponibles');
                horarios.forEach(() => estimado.push(1));
                return { estimado };
            }
            
            console.log('Estructura de datos de tráfico:', Object.keys(datosTraficoDia));
            
            // Obtener entradas por hora - Verificar diferentes estructuras posibles
            const horas = datosTraficoDia.horas || {};
            
            horarios.forEach((hora) => {
                // Intentar obtener entrada de tráfico para esta hora de diferentes maneras
                let entradasHora = 0;
                
                if (typeof horas[hora] === 'number') {
                    // Si horas es un objeto con la estructura {hora: valor}
                    entradasHora = horas[hora];
                } else if (Array.isArray(datosTraficoDia.horas)) {
                    // Si horas es un array, buscar la hora en el array
                    const horaEncontrada = datosTraficoDia.horas.find(h => h.hora === hora);
                    if (horaEncontrada) {
                        entradasHora = horaEncontrada.entradas || 0;
                    }
                }
                
                // Aplicar la fórmula: (Entradas en horario * (1 + Crecimiento))/(Atención Deseada/2)
                const resultadoFormula = (entradasHora * (1 + crecimiento)) / atencionMedia;
                const resultado = Math.max(Math.round(resultadoFormula), 1); // Asegurar valor mínimo de 1
                
                estimado.push(resultado);
                
                console.log(`Hora ${hora}: Entradas=${entradasHora}, Fórmula=${resultadoFormula.toFixed(2)}, Resultado=${resultado}`);
            });
            
            return { estimado };
        }
        
        /**
         * Genera HTML para el gráfico de tráfico
         * @param {Object} datosTraficoDia - Datos de tráfico del día
         * @returns {String} HTML del gráfico
         */
        function generarGraficoTrafico(datosTraficoDia) {
            // Si no hay horas definidas, devolver mensaje
            if (!datosTraficoDia.horas || Object.keys(datosTraficoDia.horas).length === 0) {
                return `
                    <div style="margin-top: 20px; padding: 15px; text-align: center; background-color: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 16px; color: #64748b;">No hay datos de tráfico detallados para este día</div>
                    </div>
                `;
            }
            
            // Convertir datos de tráfico a formato para gráfico
            const horasTraficoProcesadas = Object.entries(datosTraficoDia.horas)
                .map(([hora, entradas]) => ({ hora, entradas }))
                .sort((a, b) => {
                    const horaA = parseInt(a.hora.split(':')[0]);
                    const horaB = parseInt(b.hora.split(':')[0]);
                    return horaA - horaB;
                });
            
            // Encontrar el valor máximo para escalar el gráfico
            const maxEntradas = Math.max(...horasTraficoProcesadas.map(h => h.entradas), 1);
            
            return `
                <div style="margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; background-color: white;">
                    <h2 style="margin-top: 0; margin-bottom: 15px; font-size: 16px; color: #1e40af;">Tráfico por Hora</h2>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <div style="background-color: #eff6ff; border-radius: 8px; padding: 15px; flex: 1; text-align: center;">
                            <div style="font-size: 14px; color: #64748b;">Total Mañana</div>
                            <div style="font-size: 18px; font-weight: bold; color: #2563eb;">${datosTraficoDia.totalMañana || 0}</div>
                        </div>
                        <div style="background-color: #eff6ff; border-radius: 8px; padding: 15px; flex: 1; text-align: center;">
                            <div style="font-size: 14px; color: #64748b;">Total Tarde</div>
                            <div style="font-size: 18px; font-weight: bold; color: #2563eb;">${datosTraficoDia.totalTarde || 0}</div>
                        </div>
                    </div>
                    
                    <div style="height: 180px; display: flex; align-items: flex-end; gap: 4px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; margin-bottom: 10px;">
                        ${horasTraficoProcesadas.map(item => {
                            const porcentajeAltura = (item.entradas / maxEntradas) * 100;
                            const colorIntensidad = obtenerColorIntensidadTrafico(porcentajeAltura);
                            
                            return `
                                <div style="flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                    <div style="position: relative; width: 25px; height: ${Math.max(porcentajeAltura, 5)}%; background-color: ${colorIntensidad}; border-radius: 4px 4px 0 0; min-height: 4px;">
                                        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #4b5563;">${item.entradas}</div>
                                    </div>
                                    <div style="font-size: 10px; color: #64748b;">${item.hora}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #bfdbfe; border-radius: 2px;"></div>
                            <span style="font-size: 10px; color: #64748b;">0-10</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #93c5fd; border-radius: 2px;"></div>
                            <span style="font-size: 10px; color: #64748b;">11-30</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #60a5fa; border-radius: 2px;"></div>
                            <span style="font-size: 10px; color: #64748b;">31-50</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #2563eb; border-radius: 2px;"></div>
                            <span style="font-size: 10px; color: #64748b;">51-80</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #1e40af; border-radius: 2px;"></div>
                            <span style="font-size: 10px; color: #64748b;">80+</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Obtiene el color correspondiente a un estado
         * @param {String} estado - Estado (TRABAJO, VACACIONES, etc.)
         * @returns {String} Código de color
         */
        function obtenerColorEstado(estado) {
            switch (estado.toUpperCase()) {
                case 'TRABAJO':
                    return '#22c55e';
                case 'VACACIONES':
                    return '#3b82f6';
                case 'LIBRE':
                    return '#ef4444';
                case 'BAJA MÉDICA':
                    return '#8b5cf6';
                case 'FORMACIÓN':
                    return '#f97316';
                case 'LACTANCIA':
                    return '#ec4899';
                default:
                    return '#e5e7eb';
            }
        }

        /**
         * Obtiene el color según la intensidad del tráfico
         * @param {Number} porcentaje - Porcentaje de intensidad (0-100)
         * @returns {String} Código de color
         */
        function obtenerColorIntensidadTrafico(porcentaje) {
            if (porcentaje <= 10) return '#bfdbfe'; // Azul muy claro
            if (porcentaje <= 30) return '#93c5fd'; // Azul claro
            if (porcentaje <= 50) return '#60a5fa'; // Azul medio
            if (porcentaje <= 80) return '#2563eb'; // Azul fuerte
            return '#1e40af'; // Azul muy fuerte
        }
        
        /**
         * Obtiene el día de la semana en español
         * @param {Date} fecha - Objeto Date
         * @returns {String} Nombre del día
         */
        function obtenerDiaSemana(fecha) {
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            return diasSemana[fecha.getDay()];
        }

        
       function crearTablaEmpleados(actividades, tiendaData, margins) {
            return new Promise((resolve) => {
                const container = document.createElement('div');
                container.style.width = '1000px'; // Ancho fijo para mejor renderizado
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                
                const horarios = generarColumnasTiempo(
                    tiendaData.PAIS,
                    tiendaData.Apertura,
                    tiendaData.Cierre
                );
        
                const table = document.createElement('table');
                table.className = 'border-collapse w-full';
                table.style.cssText = `
                    font-family: Arial, sans-serif;
                    border-collapse: collapse;
                    width: 100%;
                `;
        
                // Crear HTML de la tabla
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th style="width: 200px; text-align: left; padding: 4px; border: 1px solid #ccc; background: #f8f9fa;">
                                Empleado
                            </th>
                            ${horarios.map(hora => `
                                <th style="width: 40px; padding: 4px; border: 1px solid #ccc; background: #f8f9fa;">
                                    <div style="writing-mode: vertical-rl; transform: rotate(180deg); height: 80px; text-align: center;">
                                        ${hora}
                                    </div>
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${actividades.map((actividad, idx) => `
                            <tr style="background: ${idx % 2 === 0 ? '#ffffff' : '#f8f9fa'}">
                                <td style="padding: 4px; border: 1px solid #ccc; font-weight: 500;">
                                    ${actividad.fields.Nombre || 'N/A'}
                                </td>
                                ${horarios.map(hora => {
                                    const estado = actividad.fields[hora] || '';
                                    const color = getEstadoColor(estado);
                                    return `
                                        <td style="padding: 4px; border: 1px solid #ccc; text-align: center;">
                                            ${estado ? `
                                                <div style="width: 16px; height: 16px; margin: 0 auto; border-radius: 50%; background: ${color};">
                                                </div>
                                            ` : ''}
                                        </td>
                                    `;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                `;
        
                container.appendChild(table);
                resolve(container);
            });
        }

        function organizarActividadesPorDia(actividades) {
            return actividades.reduce((acc, actividad) => {
                const fecha = actividad.fields.Fecha;
                if (!acc[fecha]) {
                    acc[fecha] = [];
                }
                acc[fecha].push(actividad);
                return acc;
            }, {});
        }

        function crearEstructuraPDF() {
            return new Promise((resolve) => {
                // Asegurarse de que jsPDF está disponible como variable global
                const { jsPDF } = window.jspdf;
                
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                // Configuración básica del documento
                doc.setFont('helvetica');
                doc.setFontSize(12);

                resolve(doc);
            });
        }

        // Función para generar la leyenda de iconos
        function generarLeyendaIconos(doc, yPosition) {
            const estadosIconos = {
                'TRABAJO': 'briefcase',
                'VACACIONES': 'palm-tree',
                'LIBRE': 'home',
                'BAJA MÉDICA': 'stethoscope',
                'FORMACIÓN': 'book-open',
                'LACTANCIA': 'baby'
            };


            let xPos = 10;
            const iconSize = 5;

            Object.entries(estadosIconos).forEach(([estado, icono]) => {
                // Dibujar círculo de color
                doc.setFillColor(...estadosColores[estado]);
                doc.circle(xPos, yPosition, 2, 'F');

                // Agregar texto
                doc.setTextColor(0);
                doc.text(estado, xPos + 5, yPosition);
                
                xPos += 40;
            });
        }

        // Función para crear la tabla de actividades en HTML
        function crearTablaActividades(actividades, horarios) {
            const table = document.createElement('div');
            table.className = 'w-full';
            
            const tableContent = `
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="w-48 px-4 py-2 text-left text-sm font-semibold text-gray-900 bg-gray-50 border border-gray-200">
                                Empleado
                            </th>
                            ${horarios.map(hora => `
                                <th class="w-16 px-1 py-2 text-center bg-gray-50 border border-gray-200">
                                    <div class="flex flex-col items-center">
                                        <div class="transform -rotate-90 origin-center whitespace-nowrap text-xs font-medium text-gray-500" style="width: 16px; height: 80px; line-height: 16px;">
                                            ${hora}
                                        </div>
                                    </div>
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${actividades.map((actividad, idx) => `
                            <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                <td class="px-4 py-2 text-sm font-medium text-gray-900 border border-gray-200">
                                    ${actividad.fields.Nombre || 'N/A'}
                                </td>
                                ${horarios.map(hora => {
                                    const estado = actividad.fields[hora];
                                    const colorClass = getEstadoColor(estado);
                                    return `
                                        <td class="px-1 py-2 text-center border border-gray-200">
                                            ${estado ? `
                                                <div class="w-6 h-6 mx-auto rounded-full ${colorClass} flex items-center justify-center">
                                                    ${getEstadoIcon(estado)}
                                                </div>
                                            ` : ''}
                                        </td>
                                    `;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            table.innerHTML = tableContent;
            return table;
        }


        function getEstadoColor(estado) {
            return {
                'TRABAJO': '#22c55e',
                'VACACIONES': '#3b82f6',
                'LIBRE': '#ef4444',
                'BAJA MÉDICA': '#8b5cf6',
                'FORMACIÓN': '#f97316',
                'LACTANCIA': '#ec4899'
            }[estado] || '#e5e7eb';
        }
        
        function getEstadoIcono(estado) {
            return {
                'TRABAJO': '•',
                'VACACIONES': '•',
                'LIBRE': '•',
                'BAJA MÉDICA': '•',
                'FORMACIÓN': '•',
                'LACTANCIA': '•'
            }[estado] || '';
        }

        async function generarPaginaPDF(doc, actividades, fecha, tiendaData) {
            const margins = {
                top: 20,
                bottom: 20,
                left: 15,
                right: 15
            };
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const contentWidth = pageWidth - margins.left - margins.right;
            
            // Encabezado
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Control de Horarios', pageWidth / 2, margins.top, { align: 'center' });
            
            let yPos = margins.top + 10;
            
            // Información de la semana y tienda
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text([
                `Tienda: ${tiendaData.TIENDA || 'N/A'} - N°: ${tiendaData['N°'] || 'N/A'}`,
                `Fecha: ${formatearFecha(fecha)}`
            ], pageWidth / 2, yPos, { 
                align: 'center',
                maxWidth: contentWidth
            });
            
            yPos += 20;
            
            // Generar tabla
            const tabla = crearTablaActividades(actividades, generarColumnasTiempo(tiendaData.PAIS, tiendaData.Apertura, tiendaData.Cierre));
            document.body.appendChild(tabla);
            
            // Convertir tabla a imagen
            const canvas = await html2canvas(tabla, html2canvasConfig);
            const imgData = canvas.toDataURL('image/png');
            document.body.removeChild(tabla);
            
            // Calcular dimensiones de la imagen manteniendo proporción
            const imgWidth = contentWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // Verificar si necesitamos nueva página
            if (yPos + imgHeight > pageHeight - margins.bottom) {
                doc.addPage();
                yPos = margins.top;
            }
            
            // Añadir imagen
            doc.addImage(imgData, 'PNG', margins.left, yPos, imgWidth, imgHeight);
            
            // Pie de página
            doc.setFontSize(10);
            doc.text(`Página ${doc.internal.getCurrentPageInfo().pageNumber}`, pageWidth - margins.right, pageHeight - margins.bottom, {
                align: 'right'
            });
        }

        function mostrarPreviewPDF(pdfDoc) {
            // Generar blob del PDF
            const pdfBlob = pdfDoc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);

            // Crear el modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-hidden flex items-center justify-center animate-fadeIn';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';

            // Contenido del modal
            modal.innerHTML = `
                <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 flex flex-col max-h-[90vh]">
                    <!-- Cabecera del modal -->
                    <div class="flex items-center justify-between p-4 border-b">
                        <h3 class="text-xl font-semibold text-gray-900">
                            Vista previa del PDF
                        </h3>
                        <div class="flex items-center gap-2">
                            <!-- Botón de descarga -->
                            <button id="downloadPdf" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Descargar PDF
                            </button>
                            <!-- Botón de cerrar -->
                            <button id="closeModal" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 inline-flex items-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenedor del iframe -->
                    <div class="flex-1 min-h-0 p-4">
                        <iframe 
                            src="${pdfUrl}" 
                            class="w-full h-full border-0 rounded"
                            style="min-height: 70vh;">
                        </iframe>
                    </div>
                </div>
            `;

            // Añadir estilos de animación
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                .animate-fadeIn {
                    animation: fadeIn 0.3s ease-out;
                }
            `;
            document.head.appendChild(style);

            // Añadir el modal al DOM
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden'; // Prevenir scroll

            // Event Listeners
            const closeModal = () => {
                modal.classList.add('animate-fadeOut');
                setTimeout(() => {
                    document.body.removeChild(modal);
                    document.body.style.overflow = '';
                    URL.revokeObjectURL(pdfUrl); // Liberar memoria
                }, 300);
            };

            // Cerrar modal
            modal.querySelector('#closeModal').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Descargar PDF
            modal.querySelector('#downloadPdf').addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = pdfUrl;
                link.download = `Horarios_${new Date().toISOString().split('T')[0]}.pdf`;
                link.click();
            });

            // Manejar tecla Escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') closeModal();
            };
            document.addEventListener('keydown', handleEscape);

            // Limpieza al cerrar
            return {
                close: closeModal,
                cleanup: () => {
                    document.removeEventListener('keydown', handleEscape);
                    URL.revokeObjectURL(pdfUrl);
                }
            };
        }
        
        function getStoreRecordIdFromDOM() {
            // Try multiple possible selectors
            const possibleElements = [
                // Original selector
                document.querySelector('.list-details[data-recordid]'),
                // Try section element with data-recordid
                document.querySelector('section[data-recordid]'),
                // Try the specific block class
                document.querySelector('.block-d251b643-0a11-4e15-bc71-ff7fd0bdd4cf'),
                // Try any element with data-recordid
                document.querySelector('[data-recordid]'),
                // Try section with specific classes
                document.querySelector('section.b47fa8f_15bqpe66.block-div')
            ];
        
            // Find first element that exists and has a record ID
            for (const element of possibleElements) {
                if (element && element.getAttribute('data-recordid')) {
                    const recordId = element.getAttribute('data-recordid');
                    console.log('Found store record ID:', recordId);
                    return recordId;
                }
            }
        
            // Add debug information
            console.error('Debug: DOM elements checked:', {
                'list-details': document.querySelector('.list-details'),
                'section-with-recordid': document.querySelector('section[data-recordid]'),
                'specific-block': document.querySelector('.block-d251b643-0a11-4e15-bc71-ff7fd0bdd4cf'),
                'any-recordid': document.querySelector('[data-recordid]'),
                'specific-section': document.querySelector('section.b47fa8f_15bqpe66')
            });
        
            console.error('Could not find store record ID in DOM');
            return null;
        }
        
        function showLoadingState() {
            const container = document.getElementById('lcdc-year-view');
            if (container) {
                container.innerHTML = `
                    <div class="col-span-full flex items-center justify-center gap-2 p-8">
                        <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-gray-600">Cargando datos...</span>
                    </div>
                `;
            }
        }
        
        function showErrorState(message) {
            const container = document.getElementById('lcdc-year-view');
            if (container) {
                container.innerHTML = `
                    <div class="col-span-full text-center">
                        <div class="inline-block bg-red-50 text-red-600 px-4 py-2 rounded-lg">
                            <div class="font-medium">Error al cargar los datos</div>
                            <div class="text-sm text-red-500">${message}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function initializeApplication() {
            showLoadingState();
        
            // Function to check DOM and initialize
            const initializeWithCheck = () => {
                // Small delay to ensure Softr has fully rendered
                setTimeout(() => {
                    const storeRecordId = getStoreRecordIdFromDOM();
                    
                    if (storeRecordId) {
                        window.storeRecordId = storeRecordId;
                        inicializarCalendario(storeRecordId);
                    } else {
                        // If we still can't find the ID after delay, show error state
                        showErrorState('No se pudo encontrar el ID de la tienda. Por favor, recargue la página.');
                    }
                }, 1000); // 1 second delay
            };
        
            // Wait for DOM to be fully loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeWithCheck);
            } else {
                initializeWithCheck();
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const isConnected = await verificarConexionAirtable();
            if (!isConnected) {
                console.error('Failed to connect to Airtable. Please check your API key and permissions.');
            }
        });
                
            initializeApplication();
        </script>
</body>
</html>